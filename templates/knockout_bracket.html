{% extends "base.html" %}

{% block title %}Tournament Overview - FIFA World Cup{% endblock %}
{% block main_class %}main-wide{% endblock %}

{% block content %}
<div class="knockout-header">
    <h2>Tournament Overview</h2>
    <p>Group standings and knockout predictions in one place</p>

    <div class="knockout-highlight">
        {% if champion %}
        <div class="champion-banner champion-card" style="--champion-flag-url: url('{{ champion_flag_url }}');">
            <div class="champion-flag-bg" aria-hidden="true"></div>
            <div class="champion-trophy">üèÜ</div>
            <div class="champion-info">
                <h3>Your Predicted Champion</h3>
                <div class="champion-name">
                    {% if champion_flag_url %}
                    <img class="champion-flag" src="{{ champion_flag_url }}" alt="{{ champion.name }} flag">
                    {% endif %}
                    <span>{{ champion.name }}</span>
                </div>
                <div class="champion-code">{{ champion.code }}</div>
            </div>
            <div class="champion-trophy">üèÜ</div>
        </div>
        {% endif %}

        <div class="total-score-badge score-card">
            <span class="score-label">Current Score</span>
            <span class="score-value">{{ total_score }}</span>
        </div>
    </div>
</div>

<!-- Group Standings Dashboard -->
<div id="standings-dashboard" class="standings-dashboard">
    <h3 class="section-title">Group Standings Dashboard</h3>
    <!-- Will be populated by JavaScript -->
</div>

<div class="bracket-container">
    {% set round_of_16 = [] %}
    {% set quarter_finals = [] %}
    {% set semi_finals = [] %}
    {% set knockout = namespace(third_place=None, final=None) %}

    {% for item in matches %}
        {% if item.match.round == "Round of 16" %}
            {% set _ = round_of_16.append(item) %}
        {% elif item.match.round == "Quarter Finals" %}
            {% set _ = quarter_finals.append(item) %}
        {% elif item.match.round == "Semi Finals" %}
            {% set _ = semi_finals.append(item) %}
        {% elif item.match.round == "Third Place" %}
            {% set knockout.third_place = item %}
        {% elif item.match.round == "Final" %}
            {% set knockout.final = item %}
        {% endif %}
    {% endfor %}

    <!-- Round of 16 -->
    <div class="bracket-round round-of-16">
        <h3 class="round-title">Round of 16</h3>
        <div class="matches-column">
            {% for item in round_of_16 %}
            <div class="bracket-match" data-match-id="{{ item.match.id }}">
                <div class="bracket-match-header">
                    <span class="match-num">Match #{{ item.match.match_number }}</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team1_score > item.match.actual_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score > item.prediction.predicted_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score and item.team1 and item.prediction.penalty_shootout_winner_id == item.team1.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team1_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team1_flag_url }}" alt="{{ item.team1.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team1 %}{{ item.team1.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team1.name if item.team1 else item.match.team1_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team1_score }}{% elif item.prediction %}{{ item.prediction.predicted_team1_score }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team2_score > item.match.actual_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score > item.prediction.predicted_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score == item.prediction.predicted_team1_score and item.team2 and item.prediction.penalty_shootout_winner_id == item.team2.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team2_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team2_flag_url }}" alt="{{ item.team2.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team2 %}{{ item.team2.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team2.name if item.team2 else item.match.team2_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team2_score }}{% elif item.prediction %}{{ item.prediction.predicted_team2_score }}{% else %}-{% endif %}</span>
                    </div>
                </div>
                {% if item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score %}
                <div class="penalty-indicator">‚öΩ Penalties</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Quarter Finals -->
    <div class="bracket-round quarter-finals">
        <h3 class="round-title">Quarter Finals</h3>
        <div class="matches-column">
            {% for item in quarter_finals %}
            <div class="bracket-match" data-match-id="{{ item.match.id }}">
                <div class="bracket-match-header">
                    <span class="match-num">Match #{{ item.match.match_number }}</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team1_score > item.match.actual_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score > item.prediction.predicted_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score and item.team1 and item.prediction.penalty_shootout_winner_id == item.team1.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team1_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team1_flag_url }}" alt="{{ item.team1.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team1 %}{{ item.team1.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team1.name if item.team1 else item.match.team1_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team1_score }}{% elif item.prediction %}{{ item.prediction.predicted_team1_score }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team2_score > item.match.actual_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score > item.prediction.predicted_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score == item.prediction.predicted_team1_score and item.team2 and item.prediction.penalty_shootout_winner_id == item.team2.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team2_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team2_flag_url }}" alt="{{ item.team2.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team2 %}{{ item.team2.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team2.name if item.team2 else item.match.team2_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team2_score }}{% elif item.prediction %}{{ item.prediction.predicted_team2_score }}{% else %}-{% endif %}</span>
                    </div>
                </div>
                {% if item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score %}
                <div class="penalty-indicator">‚öΩ Penalties</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Semi Finals -->
    <div class="bracket-round semi-finals">
        <h3 class="round-title">Semi Finals</h3>
        <div class="matches-column">
            {% for item in semi_finals %}
            <div class="bracket-match" data-match-id="{{ item.match.id }}">
                <div class="bracket-match-header">
                    <span class="match-num">Match #{{ item.match.match_number }}</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team1_score > item.match.actual_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score > item.prediction.predicted_team2_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score and item.team1 and item.prediction.penalty_shootout_winner_id == item.team1.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team1_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team1_flag_url }}" alt="{{ item.team1.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team1 %}{{ item.team1.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team1.name if item.team1 else item.match.team1_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team1_score }}{% elif item.prediction %}{{ item.prediction.predicted_team1_score }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="bracket-team {% if (item.match.is_finished and item.match.actual_team2_score > item.match.actual_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score > item.prediction.predicted_team1_score) or (not item.match.is_finished and item.prediction and item.prediction.predicted_team2_score == item.prediction.predicted_team1_score and item.team2 and item.prediction.penalty_shootout_winner_id == item.team2.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if item.team2_flag_url %}
                            <img class="bracket-team-flag" src="{{ item.team2_flag_url }}" alt="{{ item.team2.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if item.team2 %}{{ item.team2.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ item.team2.name if item.team2 else item.match.team2_placeholder or 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if item.match.is_finished %}{{ item.match.actual_team2_score }}{% elif item.prediction %}{{ item.prediction.predicted_team2_score }}{% else %}-{% endif %}</span>
                    </div>
                </div>
                {% if item.prediction and item.prediction.predicted_team1_score == item.prediction.predicted_team2_score %}
                <div class="penalty-indicator">‚öΩ Penalties</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Finals -->
    <div class="bracket-round finals">
        <h3 class="round-title">Final</h3>
        <div class="matches-column">
            {% if knockout.final %}
            <div class="bracket-match final-match" data-match-id="{{ knockout.final.match.id }}">
                <div class="bracket-match-header">
                    <span class="match-num">üèÜ FINAL</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team {% if (knockout.final.match.is_finished and knockout.final.match.actual_team1_score > knockout.final.match.actual_team2_score) or (not knockout.final.match.is_finished and knockout.final.prediction and knockout.final.prediction.predicted_team1_score > knockout.final.prediction.predicted_team2_score) or (not knockout.final.match.is_finished and knockout.final.prediction and knockout.final.prediction.predicted_team1_score == knockout.final.prediction.predicted_team2_score and knockout.final.team1 and knockout.final.prediction.penalty_shootout_winner_id == knockout.final.team1.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if knockout.final.team1_flag_url %}
                            <img class="bracket-team-flag" src="{{ knockout.final.team1_flag_url }}" alt="{{ knockout.final.team1.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if knockout.final.team1 %}{{ knockout.final.team1.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ knockout.final.team1.name if knockout.final.team1 else 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if knockout.final.match.is_finished %}{{ knockout.final.match.actual_team1_score }}{% elif knockout.final.prediction %}{{ knockout.final.prediction.predicted_team1_score }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="bracket-team {% if (knockout.final.match.is_finished and knockout.final.match.actual_team2_score > knockout.final.match.actual_team1_score) or (not knockout.final.match.is_finished and knockout.final.prediction and knockout.final.prediction.predicted_team2_score > knockout.final.prediction.predicted_team1_score) or (not knockout.final.match.is_finished and knockout.final.prediction and knockout.final.prediction.predicted_team2_score == knockout.final.prediction.predicted_team1_score and knockout.final.team2 and knockout.final.prediction.penalty_shootout_winner_id == knockout.final.team2.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if knockout.final.team2_flag_url %}
                            <img class="bracket-team-flag" src="{{ knockout.final.team2_flag_url }}" alt="{{ knockout.final.team2.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if knockout.final.team2 %}{{ knockout.final.team2.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ knockout.final.team2.name if knockout.final.team2 else 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if knockout.final.match.is_finished %}{{ knockout.final.match.actual_team2_score }}{% elif knockout.final.prediction %}{{ knockout.final.prediction.predicted_team2_score }}{% else %}-{% endif %}</span>
                    </div>
                </div>
                {% if knockout.final.prediction and knockout.final.prediction.predicted_team1_score == knockout.final.prediction.predicted_team2_score %}
                <div class="penalty-indicator">‚öΩ Penalties</div>
                {% endif %}
            </div>
            {% else %}
            <div class="bracket-match final-match">
                <div class="bracket-match-header">
                    <span class="match-num">üèÜ FINAL</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team">
                        <span class="team-name">
                            <span class="bracket-team-flag fallback">TBD</span>
                            <span class="team-label">TBD</span>
                        </span>
                        <span class="team-score">-</span>
                    </div>
                    <div class="bracket-team">
                        <span class="team-name">
                            <span class="bracket-team-flag fallback">TBD</span>
                            <span class="team-label">TBD</span>
                        </span>
                        <span class="team-score">-</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Third Place Match -->
            {% if knockout.third_place %}
            <div class="bracket-match third-place-match" data-match-id="{{ knockout.third_place.match.id }}">
                <div class="bracket-match-header">
                    <span class="match-num">ü•â 3rd Place</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team {% if (knockout.third_place.match.is_finished and knockout.third_place.match.actual_team1_score > knockout.third_place.match.actual_team2_score) or (not knockout.third_place.match.is_finished and knockout.third_place.prediction and knockout.third_place.prediction.predicted_team1_score > knockout.third_place.prediction.predicted_team2_score) or (not knockout.third_place.match.is_finished and knockout.third_place.prediction and knockout.third_place.prediction.predicted_team1_score == knockout.third_place.prediction.predicted_team2_score and knockout.third_place.team1 and knockout.third_place.prediction.penalty_shootout_winner_id == knockout.third_place.team1.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if knockout.third_place.team1_flag_url %}
                            <img class="bracket-team-flag" src="{{ knockout.third_place.team1_flag_url }}" alt="{{ knockout.third_place.team1.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if knockout.third_place.team1 %}{{ knockout.third_place.team1.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ knockout.third_place.team1.name if knockout.third_place.team1 else 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if knockout.third_place.match.is_finished %}{{ knockout.third_place.match.actual_team1_score }}{% elif knockout.third_place.prediction %}{{ knockout.third_place.prediction.predicted_team1_score }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="bracket-team {% if (knockout.third_place.match.is_finished and knockout.third_place.match.actual_team2_score > knockout.third_place.match.actual_team1_score) or (not knockout.third_place.match.is_finished and knockout.third_place.prediction and knockout.third_place.prediction.predicted_team2_score > knockout.third_place.prediction.predicted_team1_score) or (not knockout.third_place.match.is_finished and knockout.third_place.prediction and knockout.third_place.prediction.predicted_team2_score == knockout.third_place.prediction.predicted_team1_score and knockout.third_place.team2 and knockout.third_place.prediction.penalty_shootout_winner_id == knockout.third_place.team2.id) %}winner{% endif %}">
                        <span class="team-name">
                            {% if knockout.third_place.team2_flag_url %}
                            <img class="bracket-team-flag" src="{{ knockout.third_place.team2_flag_url }}" alt="{{ knockout.third_place.team2.name }} flag">
                            {% else %}
                            <span class="bracket-team-flag fallback">{% if knockout.third_place.team2 %}{{ knockout.third_place.team2.code }}{% else %}TBD{% endif %}</span>
                            {% endif %}
                            <span class="team-label">{{ knockout.third_place.team2.name if knockout.third_place.team2 else 'TBD' }}</span>
                        </span>
                        <span class="team-score">{% if knockout.third_place.match.is_finished %}{{ knockout.third_place.match.actual_team2_score }}{% elif knockout.third_place.prediction %}{{ knockout.third_place.prediction.predicted_team2_score }}{% else %}-{% endif %}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bracket-match third-place-match">
                <div class="bracket-match-header">
                    <span class="match-num">ü•â 3rd Place</span>
                </div>
                <div class="bracket-teams">
                    <div class="bracket-team">
                        <span class="team-name">
                            <span class="bracket-team-flag fallback">TBD</span>
                            <span class="team-label">TBD</span>
                        </span>
                        <span class="team-score">-</span>
                    </div>
                    <div class="bracket-team">
                        <span class="team-name">
                            <span class="bracket-team-flag fallback">TBD</span>
                            <span class="team-label">TBD</span>
                        </span>
                        <span class="team-score">-</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="bracket-actions">
    <a href="/bracket" class="btn btn-primary">Edit Predictions</a>
    <a href="/bracket/view" class="btn btn-secondary">View All Predictions</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Load and display group standings on knockout bracket page
async function loadStandingsDashboard() {
    try {
        const response = await fetch('/api/standings');
        const standings = await response.json();
        
        if (!standings || Object.keys(standings).length === 0) {
            const dashboard = document.getElementById('standings-dashboard');
            dashboard.innerHTML = '<h3 class="section-title">Group Standings Dashboard</h3><p class="no-standings">Make predictions for group stage matches to see standings</p>';
            return;
        }

        let html = '<h3 class="section-title">Group Standings Dashboard</h3><div class="standings-grid">';
        const groups = Object.keys(standings).sort();

        groups.forEach(groupLetter => {
            const groupStandings = standings[groupLetter];
            html += `
                <div class="group-standings">
                    <h4>Group ${groupLetter}</h4>
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>Pts</th>
                                <th>W</th>
                                <th>L</th>
                                <th>D</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            groupStandings.forEach((team, index) => {
                const qualified = index < 2 ? 'qualified' : '';
                const gdClass = team.goal_difference >= 0 ? 'positive' : 'negative';
                const flagHtml = team.team_flag_url
                    ? `<img class="standings-flag" src="${team.team_flag_url}" alt="${team.team_name} flag">`
                    : '';
                html += `
                    <tr class="${qualified}">
                        <td>${index + 1}</td>
                        <td class="team-name-cell">
                            <span class="team-name-row">
                                ${flagHtml}
                                <span class="team-code">${team.team_code}</span>
                            </span>
                            <span class="team-name-short">${team.team_name}</span>
                        </td>
                        <td class="points">${team.points}</td>
                        <td class="record-stat wins">${team.won}</td>
                        <td class="record-stat losses">${team.lost}</td>
                        <td class="record-stat draws">${team.drawn}</td>
                        <td class="goals-cell">${team.goals_for}</td>
                        <td class="goals-cell">${team.goals_against}</td>
                        <td class="goals-cell ${gdClass}">${team.goal_difference >= 0 ? '+' : ''}${team.goal_difference}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });

        html += '</div>';
        const dashboard = document.getElementById('standings-dashboard');
        if (dashboard) {
            dashboard.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading standings:', error);
    }
}

// Load standings when page loads
document.addEventListener('DOMContentLoaded', loadStandingsDashboard);
</script>
{% endblock %}
