<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https://flagcdn.com data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
    <title>World Cup Results - {{ user.username }}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/knockout_print.css">
    <style>
        @page {
            size: landscape;
            margin: 0.5cm;
        }
    </style>
</head>
<body class="print-view">
    <div class="print-container">
        <!-- Page 1: Group Stage Standings -->
        <div class="print-page-1">
            <!-- Header Section -->
            <div class="print-header">
                <div class="print-title">
                    <h1>FIFA World Cup Results</h1>
                    <p class="print-username">{{ user.username }}</p>
                </div>

                {% if champion %}
                <div class="print-champion">
                    <div class="champion-content">
                        <span class="trophy-icon">üèÜ</span>
                        {% if champion_flag_url %}
                        <img class="print-champion-flag" src="{{ champion_flag_url }}" alt="{{ champion.name }}" loading="eager" crossorigin="anonymous" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="champion-text">
                            <strong>{{ champion.name }}</strong>
                            <small>{{ 'Champion' if is_actual_champion else 'Predicted Winner' }}</small>
                        </span>
                    </div>
                </div>
                {% endif %}

                <div class="print-score">
                    <span class="score-label">Total Score</span>
                    <span class="score-number">{{ total_score }}</span>
                </div>
            </div>

            <div class="page-1-header">
                <h2>Group Stage Standings</h2>
            </div>

            {% if standings %}
            <div class="standings-grid-print">
                {% for group_letter in ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'] %}
                    {% if group_letter in standings %}
                    <div class="group-standings-print">
                        <h4 class="group-title-print">Group {{ group_letter }}</h4>
                        <table class="standings-table-print">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Team</th>
                                    <th>P</th>
                                    <th>W</th>
                                    <th>D</th>
                                    <th>L</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>GD</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team_standing in standings[group_letter] %}
                                <tr class="{% if loop.index <= 2 %}qualified-row{% endif %}">
                                    <td class="pos-cell">{{ loop.index }}</td>
                                    <td class="team-cell-print">
                                        {% if team_standing.team_flag_url %}
                                        <img src="{{ team_standing.team_flag_url }}" alt="{{ team_standing.team.code }}" class="team-flag-print" referrerpolicy="no-referrer">
                                        {% endif %}
                                        <span class="team-code-print">{{ team_standing.team.code }}</span>
                                    </td>
                                    <td>{{ team_standing.played }}</td>
                                    <td class="stat-win">{{ team_standing.won }}</td>
                                    <td class="stat-draw">{{ team_standing.drawn }}</td>
                                    <td class="stat-loss">{{ team_standing.lost }}</td>
                                    <td>{{ team_standing.goals_for }}</td>
                                    <td>{{ team_standing.goals_against }}</td>
                                    <td class="{% if team_standing.goal_difference >= 0 %}positive-gd{% else %}negative-gd{% endif %}">
                                        {{ '+' if team_standing.goal_difference > 0 else '' }}{{ team_standing.goal_difference }}
                                    </td>
                                    <td class="points-cell"><strong>{{ team_standing.points }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Page Break -->
        <div class="page-break"></div>

        <!-- Page 2: Knockout Bracket -->
        <div class="print-bracket">
            {% set round_of_16 = [] %}
            {% set quarter_finals = [] %}
            {% set semi_finals = [] %}
            {% set knockout = namespace(third_place=None, final=None) %}

            {% for item in matches %}
                {% if item.match.round == "Round of 16" %}
                    {% set _ = round_of_16.append(item) %}
                {% elif item.match.round == "Quarter Finals" %}
                    {% set _ = quarter_finals.append(item) %}
                {% elif item.match.round == "Semi Finals" %}
                    {% set _ = semi_finals.append(item) %}
                {% elif item.match.round == "Third Place" %}
                    {% set knockout.third_place = item %}
                {% elif item.match.round == "Final" %}
                    {% set knockout.final = item %}
                {% endif %}
            {% endfor %}

            <!-- Round of 16 -->
            <div class="bracket-column r16">
                <h4>Round of 16</h4>
                {% for item in round_of_16 %}
                <div class="print-match">
                    <div class="print-team {% if item.winner_position == 1 %}winner{% endif %}">
                        {% if item.team1_flag_url %}
                        <img src="{{ item.team1_flag_url }}" alt="{{ item.team1.code if item.team1 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team1.code if item.team1 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team1_score }}
                                {% if item.match.actual_team1_penalty_score is not none %}
                                <small>({{ item.match.actual_team1_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team1_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                    <div class="print-team {% if item.winner_position == 2 %}winner{% endif %}">
                        {% if item.team2_flag_url %}
                        <img src="{{ item.team2_flag_url }}" alt="{{ item.team2.code if item.team2 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team2.code if item.team2 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team2_score }}
                                {% if item.match.actual_team2_penalty_score is not none %}
                                <small>({{ item.match.actual_team2_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team2_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Quarter Finals -->
            <div class="bracket-column quarters">
                <h4>Quarter Finals</h4>
                {% for item in quarter_finals %}
                <div class="print-match">
                    <div class="print-team {% if item.winner_position == 1 %}winner{% endif %}">
                        {% if item.team1_flag_url %}
                        <img src="{{ item.team1_flag_url }}" alt="{{ item.team1.code if item.team1 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team1.code if item.team1 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team1_score }}
                                {% if item.match.actual_team1_penalty_score is not none %}
                                <small>({{ item.match.actual_team1_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team1_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                    <div class="print-team {% if item.winner_position == 2 %}winner{% endif %}">
                        {% if item.team2_flag_url %}
                        <img src="{{ item.team2_flag_url }}" alt="{{ item.team2.code if item.team2 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team2.code if item.team2 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team2_score }}
                                {% if item.match.actual_team2_penalty_score is not none %}
                                <small>({{ item.match.actual_team2_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team2_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Semi Finals -->
            <div class="bracket-column semis">
                <h4>Semi Finals</h4>
                {% for item in semi_finals %}
                <div class="print-match">
                    <div class="print-team {% if item.winner_position == 1 %}winner{% endif %}">
                        {% if item.team1_flag_url %}
                        <img src="{{ item.team1_flag_url }}" alt="{{ item.team1.code if item.team1 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team1.code if item.team1 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team1_score }}
                                {% if item.match.actual_team1_penalty_score is not none %}
                                <small>({{ item.match.actual_team1_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team1_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                    <div class="print-team {% if item.winner_position == 2 %}winner{% endif %}">
                        {% if item.team2_flag_url %}
                        <img src="{{ item.team2_flag_url }}" alt="{{ item.team2.code if item.team2 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ item.team2.code if item.team2 else 'TBD' }}</span>
                        <span class="score">
                            {% if item.match.is_finished %}
                                {{ item.match.actual_team2_score }}
                                {% if item.match.actual_team2_penalty_score is not none %}
                                <small>({{ item.match.actual_team2_penalty_score }})</small>
                                {% endif %}
                            {% elif item.prediction %}
                                {{ item.prediction.predicted_team2_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Finals Column -->
            <div class="bracket-column finals">
                <h4>Final</h4>
                {% if knockout.final %}
                <div class="print-match final">
                    <div class="print-team {% if knockout.final.winner_position == 1 %}winner{% endif %}">
                        {% if knockout.final.team1_flag_url %}
                        <img src="{{ knockout.final.team1_flag_url }}" alt="{{ knockout.final.team1.code if knockout.final.team1 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ knockout.final.team1.code if knockout.final.team1 else 'TBD' }}</span>
                        <span class="score">
                            {% if knockout.final.match.is_finished %}
                                {{ knockout.final.match.actual_team1_score }}
                                {% if knockout.final.match.actual_team1_penalty_score is not none %}
                                <small>({{ knockout.final.match.actual_team1_penalty_score }})</small>
                                {% endif %}
                            {% elif knockout.final.prediction %}
                                {{ knockout.final.prediction.predicted_team1_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                    <div class="print-team {% if knockout.final.winner_position == 2 %}winner{% endif %}">
                        {% if knockout.final.team2_flag_url %}
                        <img src="{{ knockout.final.team2_flag_url }}" alt="{{ knockout.final.team2.code if knockout.final.team2 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ knockout.final.team2.code if knockout.final.team2 else 'TBD' }}</span>
                        <span class="score">
                            {% if knockout.final.match.is_finished %}
                                {{ knockout.final.match.actual_team2_score }}
                                {% if knockout.final.match.actual_team2_penalty_score is not none %}
                                <small>({{ knockout.final.match.actual_team2_penalty_score }})</small>
                                {% endif %}
                            {% elif knockout.final.prediction %}
                                {{ knockout.final.prediction.predicted_team2_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}

                <h4>3rd Place</h4>
                {% if knockout.third_place %}
                <div class="print-match third">
                    <div class="print-team {% if knockout.third_place.winner_position == 1 %}winner{% endif %}">
                        {% if knockout.third_place.team1_flag_url %}
                        <img src="{{ knockout.third_place.team1_flag_url }}" alt="{{ knockout.third_place.team1.code if knockout.third_place.team1 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ knockout.third_place.team1.code if knockout.third_place.team1 else 'TBD' }}</span>
                        <span class="score">
                            {% if knockout.third_place.match.is_finished %}
                                {{ knockout.third_place.match.actual_team1_score }}
                                {% if knockout.third_place.match.actual_team1_penalty_score is not none %}
                                <small>({{ knockout.third_place.match.actual_team1_penalty_score }})</small>
                                {% endif %}
                            {% elif knockout.third_place.prediction %}
                                {{ knockout.third_place.prediction.predicted_team1_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                    <div class="print-team {% if knockout.third_place.winner_position == 2 %}winner{% endif %}">
                        {% if knockout.third_place.team2_flag_url %}
                        <img src="{{ knockout.third_place.team2_flag_url }}" alt="{{ knockout.third_place.team2.code if knockout.third_place.team2 else 'TBD' }}" referrerpolicy="no-referrer">
                        {% endif %}
                        <span class="team-code">{{ knockout.third_place.team2.code if knockout.third_place.team2 else 'TBD' }}</span>
                        <span class="score">
                            {% if knockout.third_place.match.is_finished %}
                                {{ knockout.third_place.match.actual_team2_score }}
                                {% if knockout.third_place.match.actual_team2_penalty_score is not none %}
                                <small>({{ knockout.third_place.match.actual_team2_penalty_score }})</small>
                                {% endif %}
                            {% elif knockout.third_place.prediction %}
                                {{ knockout.third_place.prediction.predicted_team2_score }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Print Actions (hidden when printing) -->
        <div class="print-actions no-print">
            <button onclick="window.print()" class="btn-print">Print / Save as PDF</button>
            <a href="/bracket/knockout" class="btn-back">Back to Results</a>
        </div>
    </div>

    <script>
        // Ensure all images are loaded before printing
        window.addEventListener('load', function() {
            const images = document.querySelectorAll('img');
            let loadedCount = 0;
            const totalImages = images.length;

            if (totalImages === 0) {
                console.log('No images to load');
                return;
            }

            images.forEach(img => {
                if (img.complete) {
                    loadedCount++;
                } else {
                    img.addEventListener('load', function() {
                        loadedCount++;
                        console.log(`Loaded ${loadedCount}/${totalImages} images`);
                    });
                    img.addEventListener('error', function() {
                        loadedCount++;
                        console.error(`Failed to load image: ${img.src}`);
                        this.style.display = 'none';
                    });
                }
            });

            console.log(`Total images: ${totalImages}, Initially loaded: ${loadedCount}`);
        });

        // Debug: Log flag URLs
        document.addEventListener('DOMContentLoaded', function() {
            const flagImages = document.querySelectorAll('img[src*="flagcdn"]');
            console.log(`Found ${flagImages.length} flag images`);
            flagImages.forEach((img, index) => {
                console.log(`Flag ${index + 1}: ${img.src}`);
            });
        });
    </script>
</body>
</html>
