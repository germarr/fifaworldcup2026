{% extends "base.html" %}

{% block title %}Select Your Bracket - FIFA World Cup{% endblock %}
{% block main_class %}main-wide{% endblock %}

{% block content %}
<div class="bracket-header">
    <h2>Create Your Bracket Predictions</h2>
    <p>Predict scores for each match and see your group standings update in real-time!</p>

    <div class="mode-selector">
        <button id="mode-all" class="btn btn-primary mode-btn active">Game Mode</button>
        <button id="mode-individual" class="btn btn-secondary mode-btn">Individual Matches</button>
    </div>
</div>

<details class="standings-toggle" id="standings-toggle">
    <summary class="standings-toggle-summary">
        Group Standings Dashboard
        <span class="standings-toggle-hint">Click to expand</span>
    </summary>
    <div id="standings-dashboard" class="standings-dashboard">
        <!-- Will be populated by JavaScript -->
    </div>
</details>

<!-- Game Mode (previously "All At Once") -->
<div id="all-at-once-mode" class="prediction-mode game-mode">
    <div class="game-instructions">
        <h3>How Game Mode Works</h3>
        <p>Enter scores match by match. Your picks save as you go.</p>
        <p>üé≤ Pick for me! fills only the current match. Pick the entire Tournament runs a full simulation to generate official results.</p>
    </div>

    <div class="tournament-actions">
        <button id="pick-entire-tournament-btn" class="btn btn-secondary">
            üèÜ Pick the entire Tournament
        </button>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-bar-container">
        <div class="progress-info">
            <span>Match <span id="current-match-num">1</span> of <span id="total-matches">64</span></span>
            <span class="round-indicator" id="current-round">Group Stage - Group A</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Single Match Card (Game-like) -->
    <div id="match-card-container" class="match-card-large">
        <div class="match-header">
            <span class="match-round" id="card-round">Loading...</span>
            <span class="match-number" id="card-match-number">Match #1</span>
        </div>

        <div class="match-date" id="card-date"></div>

        <div class="match-teams-large">
            <!-- Team 1 -->
            <div class="team-container team-1">
                <div class="team-flag" id="team1-flag"></div>
                <h3 class="team-name" id="team1-name">Team 1</h3>
                <input
                    type="number"
                    id="team1-score"
                    class="score-input-large"
                    min="0"
                    max="20"
                    placeholder="0"
                >
            </div>

            <div class="vs-large">VS</div>

            <!-- Team 2 -->
            <div class="team-container team-2">
                <div class="team-flag" id="team2-flag"></div>
                <h3 class="team-name" id="team2-name">Team 2</h3>
                <input
                    type="number"
                    id="team2-score"
                    class="score-input-large"
                    min="0"
                    max="20"
                    placeholder="0"
                >
            </div>
        </div>

        <!-- Penalty Shootout Selector (for tied knockout matches) -->
        <div id="penalty-shootout-container" class="penalty-shootout-container" style="display: none;">
            <div class="penalty-info">
                <span class="penalty-icon">‚öΩ</span>
                <span class="penalty-text">Match is tied! Select penalty shootout winner:</span>
            </div>
            <select id="penalty-winner" class="penalty-select">
                <option value="">Select Winner</option>
                <option id="penalty-option-team1" value=""></option>
                <option id="penalty-option-team2" value=""></option>
            </select>
        </div>

        <!-- Navigation Buttons -->
        <div class="game-navigation">
            <button id="prev-btn" class="btn btn-secondary nav-btn">
                <span>‚Üê Previous</span>
            </button>

            <button id="skip-btn" class="btn btn-secondary nav-btn">
                <span>Skip</span>
            </button>

            <button id="pick-for-me-btn" class="btn btn-secondary nav-btn" title="Randomly fill the current match">
                <span>üé≤ Pick for me!</span>
            </button>

            <button id="next-btn" class="btn btn-primary nav-btn">
                <span>Next ‚Üí</span>
            </button>
        </div>

        <div class="completion-message" id="completion-message" style="display: none;">
            <h3>üéâ All matches predicted!</h3>
            <p>You've completed your bracket predictions. You can review or modify them anytime.</p>
            <a href="/bracket/view" class="btn btn-primary btn-large">View My Bracket</a>
        </div>
    </div>
</div>

<!-- Individual Mode -->
<div id="individual-mode" class="prediction-mode individual-mode" style="display: none;">
    <div class="mode-info">
        <p>Enter or update predictions for each match. Changes are saved automatically.</p>
    </div>

    <div class="individual-matches-grid">
        {% for item in matches_with_teams %}
        {% set match = item.match %}
        {% set round_class = '' %}
        {% if 'Group A' in match.round %}{% set round_class = 'group-a' %}
        {% elif 'Group B' in match.round %}{% set round_class = 'group-b' %}
        {% elif 'Group C' in match.round %}{% set round_class = 'group-c' %}
        {% elif 'Group D' in match.round %}{% set round_class = 'group-d' %}
        {% elif 'Group E' in match.round %}{% set round_class = 'group-e' %}
        {% elif 'Group F' in match.round %}{% set round_class = 'group-f' %}
        {% elif 'Group G' in match.round %}{% set round_class = 'group-g' %}
        {% elif 'Group H' in match.round %}{% set round_class = 'group-h' %}
        {% elif 'Round of 16' in match.round or 'Quarter' in match.round or 'Semi' in match.round %}{% set round_class = 'knockout-round' %}
        {% elif 'Third' in match.round or match.round == 'Final' %}{% set round_class = 'final-round' %}
        {% endif %}
        <div class="individual-match-card {{ round_class }} {% if match.id in predictions %}has-prediction{% endif %}" data-match-id="{{ match.id }}">
            <div class="individual-match-header">
                <span class="match-round">{{ match.round }}</span>
                <span class="match-number">Match #{{ match.match_number }}</span>
            </div>

            <div class="individual-match-teams">
                <div class="individual-team">
                    <div class="team-flag-small">
                        {% if item.team1_flag_url %}
                            <img src="{{ item.team1_flag_url }}" alt="{{ item.team1.code }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                        {% elif item.team1 %}
                            {{ item.team1.code }}
                        {% else %}
                            {{ match.team1_placeholder or 'TBD' }}
                        {% endif %}
                    </div>
                    <span class="team-name-individual">
                        {% if item.team1 %}
                            {{ item.team1.code }}
                        {% else %}
                            {{ match.team1_placeholder or 'TBD' }}
                        {% endif %}
                    </span>
                    <input
                        type="number"
                        class="score-input-individual team1-score"
                        data-match-id="{{ match.id }}"
                        min="0"
                        max="20"
                        placeholder="0"
                        value="{% if match.id in predictions %}{{ predictions[match.id].predicted_team1_score }}{% endif %}"
                    >
                </div>

                <div class="vs-individual">VS</div>

                <div class="individual-team">
                    <div class="team-flag-small">
                        {% if item.team2_flag_url %}
                            <img src="{{ item.team2_flag_url }}" alt="{{ item.team2.code }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                        {% elif item.team2 %}
                            {{ item.team2.code }}
                        {% else %}
                            {{ match.team2_placeholder or 'TBD' }}
                        {% endif %}
                    </div>
                    <span class="team-name-individual">
                        {% if item.team2 %}
                            {{ item.team2.code }}
                        {% else %}
                            {{ match.team2_placeholder or 'TBD' }}
                        {% endif %}
                    </span>
                    <input
                        type="number"
                        class="score-input-individual team2-score"
                        data-match-id="{{ match.id }}"
                        min="0"
                        max="20"
                        placeholder="0"
                        value="{% if match.id in predictions %}{{ predictions[match.id].predicted_team2_score }}{% endif %}"
                    >
                </div>
            </div>

            <!-- Penalty Shootout for Individual Mode -->
            {% if not match.round.startswith('Group Stage') %}
            <div class="penalty-shootout-individual" data-match-id="{{ match.id }}" style="display: none;">
                <span class="penalty-text-small">‚öΩ Tied - Penalty winner:</span>
                <select class="penalty-select-individual" data-match-id="{{ match.id }}">
                    <option value="">Select</option>
                    <option value="team1">
                        {% if item.team1 %}
                            {{ item.team1.name }}
                        {% else %}
                            Team 1
                        {% endif %}
                    </option>
                    <option value="team2">
                        {% if item.team2 %}
                            {{ item.team2.name }}
                        {% else %}
                            Team 2
                        {% endif %}
                    </option>
                </select>
            </div>
            {% endif %}

            <button class="btn btn-primary btn-small save-individual-btn" data-match-id="{{ match.id }}">
                Save
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<div id="notification" class="notification" style="display: none;"></div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/bracket.js"></script>
<script>
async function loadStandingsDashboard() {
    try {
        const response = await fetch('/api/standings');
        const standings = await response.json();

        const dashboard = document.getElementById('standings-dashboard');
        if (!dashboard) {
            return;
        }

        if (!standings || Object.keys(standings).length === 0) {
            dashboard.innerHTML = '<h3 class="section-title">Group Standings Dashboard</h3><p class="no-standings">Make predictions for group stage matches to see standings</p>';
            return;
        }

        let html = '<h3 class="section-title">Group Standings Dashboard</h3><div class="standings-grid">';
        const groups = Object.keys(standings).sort();

        const flagCodeMap = {
            ARG: 'ar', AUS: 'au', BEL: 'be', BRA: 'br', CAN: 'ca',
            CMR: 'cm', CRC: 'cr', CRO: 'hr', DEN: 'dk', ECU: 'ec',
            ENG: 'gb-eng', ESP: 'es', FRA: 'fr', GER: 'de', GHA: 'gh',
            IRN: 'ir', JPN: 'jp', KOR: 'kr', KSA: 'sa', MAR: 'ma',
            MEX: 'mx', NED: 'nl', POL: 'pl', POR: 'pt', QAT: 'qa',
            SEN: 'sn', SRB: 'rs', SUI: 'ch', TUN: 'tn', URU: 'uy',
            USA: 'us', WAL: 'gb-wls'
        };

        const buildFlagUrl = (teamCode) => {
            if (!teamCode || !flagCodeMap[teamCode]) {
                return '';
            }
            const code = flagCodeMap[teamCode];
            return `https://flagcdn.com/w40/${code}.png`;
        };

        groups.forEach(groupLetter => {
            const groupStandings = standings[groupLetter];
            html += `
                <div class="group-standings">
                    <h4>Group ${groupLetter}</h4>
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>Pts</th>
                                <th>W</th>
                                <th>L</th>
                                <th>D</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            groupStandings.forEach((team, index) => {
                const qualified = index < 2 ? 'qualified' : '';
                const gdClass = team.goal_difference >= 0 ? 'positive' : 'negative';
                const flagUrl = team.team_flag_url || buildFlagUrl(team.team_code);
                const flagHtml = flagUrl
                    ? `<img class="standings-flag" src="${flagUrl}" alt="${team.team_name} flag">`
                    : '';
                html += `
                    <tr class="${qualified}">
                        <td>${index + 1}</td>
                        <td class="team-name-cell">
                            <span class="team-name-row">
                                ${flagHtml}
                                <span class="team-code">${team.team_code}</span>
                            </span>
                            <span class="team-name-short">${team.team_name}</span>
                        </td>
                        <td class="points">${team.points}</td>
                        <td class="record-stat wins">${team.won}</td>
                        <td class="record-stat losses">${team.lost}</td>
                        <td class="record-stat draws">${team.drawn}</td>
                        <td class="goals-cell">${team.goals_for}</td>
                        <td class="goals-cell">${team.goals_against}</td>
                        <td class="goals-cell ${gdClass}">${team.goal_difference >= 0 ? '+' : ''}${team.goal_difference}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });

        html += '</div>';
        dashboard.innerHTML = html;
    } catch (error) {
        console.error('Error loading standings:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadStandingsDashboard);
</script>
{% endblock %}
