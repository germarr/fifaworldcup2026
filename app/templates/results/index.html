{% extends "base.html" %}
{% from "components/team_flag.html" import flag %}

{% block title %}My Results - FIFA World Cup 2026{% endblock %}

{% block head %}
<style>
    .result-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }
    .result-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .result-correct {
        border-left: 4px solid #22c55e;
    }
    .result-partial {
        border-left: 4px solid #c9a227;
    }
    .result-incorrect {
        border-left: 4px solid #f87171;
    }
    .result-pending {
        border-left: 4px solid #d1d5db;
    }
    .points-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 700;
    }
    .round-nav {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f3f4f6;
        padding: 0.5rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">My Results</h1>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <!-- Total Points -->
        <div class="card bg-fifa-blue text-white text-center">
            <div class="text-sm opacity-75">Total Points</div>
            <div class="text-4xl font-bold">{{ summary.total_points }}</div>
        </div>

        <!-- Predictions Made -->
        <div class="card text-center">
            <div class="text-sm text-gray-500">Predictions</div>
            <div class="text-2xl font-bold text-fifa-dark">{{ summary.total_predictions }}</div>
        </div>

        <!-- Exact Scores -->
        <div class="card text-center bg-green-50 border border-green-200">
            <div class="text-sm text-green-600">Exact Scores</div>
            <div class="text-2xl font-bold text-green-700">{{ summary.exact_scores }}</div>
        </div>

        <!-- Pending -->
        <div class="card text-center bg-yellow-50 border border-yellow-200">
            <div class="text-sm text-yellow-600">Pending</div>
            <div class="text-2xl font-bold text-yellow-700">{{ summary.pending_matches }}</div>
        </div>
    </div>

    <!-- Points by Round Breakdown -->
    <div class="card mb-8">
        <h2 class="text-lg font-bold mb-4">Points by Round</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
            {% for round_key, round_label in round_order %}
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-xs text-gray-500 truncate">{{ round_label }}</div>
                    <div class="text-xl font-bold text-fifa-blue">
                        {{ summary.points_by_round.get(round_key, 0) }}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    {% if results_by_round %}
        <!-- Round Filter Navigation -->
        <div class="round-nav flex flex-wrap gap-2 mb-6">
            {% for round_key, round_label in round_order %}
                {% if round_key in results_by_round %}
                    <a href="#{{ round_key }}" class="btn-secondary text-sm py-1 px-3">
                        {{ round_label }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Results by Round -->
        {% for round_key, round_label in round_order %}
            {% if round_key in results_by_round %}
                <div id="{{ round_key }}" class="mb-10 scroll-mt-16">
                    <!-- Round Header -->
                    <h2 class="text-2xl font-bold mb-4 {% if round_key == 'group_stage' %}text-blue-600{% elif round_key == 'knockout_stage_roundof32' %}text-red-600{% elif round_key == 'knockout_stage_roundof16' %}text-orange-600{% elif round_key == 'knockout_stage_quarterfinal' %}text-yellow-600{% elif round_key == 'knockout_stage_semifinal' %}text-purple-600{% elif round_key == 'knockout_stage_thirdplace' %}text-amber-700{% elif round_key == 'knockout_stage_final' %}text-fifa-gold{% endif %}">
                        {% if round_key == 'knockout_stage_final' %}
                            <span class="mr-1">&#128081;</span>
                        {% elif round_key == 'knockout_stage_thirdplace' %}
                            <span class="mr-1">&#129353;</span>
                        {% endif %}
                        {{ round_label }}
                        <span class="text-base font-normal text-gray-400 ml-2">({{ results_by_round[round_key]|length }} predictions)</span>
                    </h2>

                    <!-- Match Results Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {% for result in results_by_round[round_key] %}
                            <div class="result-card p-4 {% if result.result_status == 'correct' %}result-correct{% elif result.result_status == 'partial' %}result-partial{% elif result.result_status == 'incorrect' %}result-incorrect{% else %}result-pending{% endif %}">
                                <!-- Match Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-xs text-gray-500">
                                        Match #{{ result.match_number }}
                                        {% if result.group_letter %}
                                            <span class="text-gray-400">| Group {{ result.group_letter }}</span>
                                        {% endif %}
                                    </div>
                                    <!-- Points Badge -->
                                    {% if result.is_completed %}
                                        <span class="points-badge {{ result.points_class }}">
                                            {{ result.points_display }}
                                        </span>
                                    {% else %}
                                        <span class="text-xs text-gray-400 italic">Awaiting Result</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500 mb-3">
                                    {% if result.scheduled_datetime %}
                                        <span>{{ result.scheduled_datetime.strftime('%b %d, %Y %H:%M') }}</span>
                                    {% endif %}
                                    {% if result.stadium %}
                                        <span class="ml-1">• {{ result.stadium.city }} — {{ result.stadium.name }}</span>
                                    {% endif %}
                                </div>

                                <!-- Two Column Layout: Prediction vs Actual -->
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- YOUR PREDICTION -->
                                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                        <div class="text-xs font-semibold text-blue-600 mb-3 text-center uppercase tracking-wide">Your Prediction</div>

                                        <!-- Home Team -->
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-1.5 flex-1 min-w-0">
                                                {% if result.home_team %}
                                                    {{ flag(result.home_team.country_code, 20) }}
                                                    <span class="text-sm font-medium truncate">{{ result.home_team.name }}</span>
                                                {% else %}
                                                    <span class="text-sm text-gray-400">TBD</span>
                                                {% endif %}
                                            </div>
                                            <span class="text-lg font-bold text-blue-700 ml-2">
                                                {{ result.predicted_home_score if result.predicted_home_score is not none else '-' }}
                                            </span>
                                        </div>

                                        <!-- Away Team -->
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-1.5 flex-1 min-w-0">
                                                {% if result.away_team %}
                                                    {{ flag(result.away_team.country_code, 20) }}
                                                    <span class="text-sm font-medium truncate">{{ result.away_team.name }}</span>
                                                {% else %}
                                                    <span class="text-sm text-gray-400">TBD</span>
                                                {% endif %}
                                            </div>
                                            <span class="text-lg font-bold text-blue-700 ml-2">
                                                {{ result.predicted_away_score if result.predicted_away_score is not none else '-' }}
                                            </span>
                                        </div>

                                        <!-- Knockout Winner Prediction -->
                                        {% if result.is_knockout and result.predicted_winner %}
                                            <div class="mt-2 pt-2 border-t border-blue-200 text-xs text-center">
                                                <span class="text-blue-500">Winner:</span>
                                                <span class="font-semibold text-blue-700">{{ result.predicted_winner.name }}</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- ACTUAL RESULT -->
                                    <div class="{% if result.is_completed %}{% if result.result_status == 'correct' %}bg-green-50 border-green-200{% elif result.result_status == 'partial' %}bg-yellow-50 border-yellow-200{% else %}bg-red-50 border-red-200{% endif %}{% else %}bg-gray-50 border-gray-200{% endif %} rounded-lg p-3 border">
                                        <div class="text-xs font-semibold {% if result.is_completed %}{% if result.result_status == 'correct' %}text-green-600{% elif result.result_status == 'partial' %}text-yellow-600{% else %}text-red-600{% endif %}{% else %}text-gray-400{% endif %} mb-3 text-center uppercase tracking-wide">
                                            {% if result.is_completed %}Actual Result{% else %}Pending{% endif %}
                                        </div>

                                        {% if result.is_completed %}
                                            <!-- Home Team -->
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-1.5 flex-1 min-w-0">
                                                    {% if result.home_team %}
                                                        {{ flag(result.home_team.country_code, 20) }}
                                                        <span class="text-sm font-medium truncate">{{ result.home_team.name }}</span>
                                                    {% else %}
                                                        <span class="text-sm text-gray-400">TBD</span>
                                                    {% endif %}
                                                </div>
                                                <span class="text-lg font-bold {% if result.result_status == 'correct' %}text-green-700{% elif result.result_status == 'partial' %}text-yellow-700{% else %}text-red-700{% endif %} ml-2">
                                                    {{ result.actual_home_score }}
                                                </span>
                                            </div>

                                            <!-- Away Team -->
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-1.5 flex-1 min-w-0">
                                                    {% if result.away_team %}
                                                        {{ flag(result.away_team.country_code, 20) }}
                                                        <span class="text-sm font-medium truncate">{{ result.away_team.name }}</span>
                                                    {% else %}
                                                        <span class="text-sm text-gray-400">TBD</span>
                                                    {% endif %}
                                                </div>
                                                <span class="text-lg font-bold {% if result.result_status == 'correct' %}text-green-700{% elif result.result_status == 'partial' %}text-yellow-700{% else %}text-red-700{% endif %} ml-2">
                                                    {{ result.actual_away_score }}
                                                </span>
                                            </div>

                                            <!-- Knockout Actual Winner -->
                                            {% if result.is_knockout and result.actual_winner %}
                                                <div class="mt-2 pt-2 border-t {% if result.result_status == 'correct' %}border-green-200{% elif result.result_status == 'partial' %}border-yellow-200{% else %}border-red-200{% endif %} text-xs text-center">
                                                    <span class="{% if result.result_status == 'correct' %}text-green-500{% elif result.result_status == 'partial' %}text-yellow-500{% else %}text-red-500{% endif %}">Winner:</span>
                                                    <span class="font-semibold {% if result.result_status == 'correct' %}text-green-700{% elif result.result_status == 'partial' %}text-yellow-700{% else %}text-red-700{% endif %}">
                                                        {{ result.actual_winner.name }}
                                                        {% if result.predicted_winner and result.predicted_winner.id == result.actual_winner.id %}
                                                            <span class="ml-1">&#10003;</span>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Pending State -->
                                            <div class="flex items-center justify-center h-16 text-gray-400">
                                                <div class="text-center">
                                                    <div class="text-2xl mb-1">&#8987;</div>
                                                    <div class="text-xs">Not played yet</div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Outcome Summary Footer -->
                                {% if result.is_completed %}
                                    <div class="mt-3 pt-2 border-t border-gray-100 text-center">
                                        <span class="text-xs font-medium {% if result.result_status == 'correct' %}text-green-600{% elif result.result_status == 'partial' %}text-yellow-700{% else %}text-red-500{% endif %}">
                                            {{ result.points_breakdown }}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}

    {% else %}
        <!-- Empty State -->
        <div class="card text-center py-12">
            <div class="text-6xl mb-4">&#9917;</div>
            <p class="text-gray-500 mb-4">You haven't made any predictions yet.</p>
            <a href="/bracket/groups" class="btn-primary">Start Predicting</a>
        </div>
    {% endif %}

    <!-- Scoring Info Banner -->
    <div class="bg-gradient-to-r from-slate-200 to-slate-300 text-slate-900 rounded-lg p-6 mt-8 shadow-md border border-slate-400">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="text-2xl">&#9989;</span> Scoring System
        </h2>
        <div class="grid md:grid-cols-2 gap-6 text-sm">
            <div>
                <p class="font-semibold mb-2">Group Stage:</p>
                <ul class="ml-4 list-disc space-y-1">
                    <li><strong>1 point</strong> - Correct outcome (H/D/A)</li>
                    <li><strong>3 points</strong> - Exact score (replaces outcome points)</li>
                </ul>
            </div>
            <div>
                <p class="font-semibold mb-2">Knockout Rounds:</p>
                <ul class="ml-4 list-disc space-y-1">
                    <li><strong>2 points</strong> - Correct winner</li>
                    <li><strong>3 points</strong> - Exact score (replaces winner points)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
