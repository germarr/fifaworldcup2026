{% extends "base.html" %}

{% block title %}Knockout Bracket - FIFA World Cup 2026{% endblock %}

{% block head %}
<style>
    .match-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        min-width: 200px;
    }
    .match-card.has-prediction {
        border-color: #22c55e;
        background: #f0fdf4;
    }
    .team-slot {
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .team-slot:hover {
        background: #e2e8f0;
    }
    .team-slot.winner {
        background: #dcfce7;
        border: 2px solid #22c55e;
    }
    .team-slot.loser {
        opacity: 0.5;
    }
    .team-slot.tbd {
        background: #f1f5f9;
        color: #94a3b8;
        font-style: italic;
    }
    .team-flag {
        width: 24px;
        height: 16px;
        object-fit: cover;
        border-radius: 2px;
    }
    .round-section {
        margin-bottom: 2rem;
    }
    .bracket-connector {
        position: relative;
    }
    .vs-badge {
        background: #1e293b;
        color: white;
        font-size: 0.625rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        text-align: center;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        border: 2px dashed #e2e8f0;
    }
    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Knockout Bracket</h1>

    <!-- Progress Banner -->
    <div class="bg-white rounded-lg p-4 mb-6 shadow-sm border">
        <div class="flex items-center justify-between mb-2">
            <span class="font-semibold">Group Stage Predictions</span>
            <span id="prediction-progress" class="text-sm text-gray-600">0/72 matches</span>
        </div>
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <p id="progress-message" class="text-sm text-gray-500 mt-2">Complete your group stage predictions to see the knockout bracket.</p>
    </div>

    <!-- Instructions Banner -->
    <div class="bg-gradient-to-r from-slate-200 to-slate-300 text-slate-900 rounded-lg p-6 mb-8 shadow-md border border-slate-400">
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-xl font-bold mb-4">&#127942; How It Works</h2>
                <div class="space-y-2 text-sm">
                    <p><strong>1.</strong> Complete your group stage predictions first</p>
                    <p><strong>2.</strong> The bracket will populate based on your predicted standings</p>
                    <p><strong>3.</strong> Click on teams to predict knockout match winners</p>
                    <p><strong>4.</strong> Winners advance automatically through the bracket</p>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-4">&#128279; Share Your Bracket</h2>
                <p class="text-sm mb-4">Your entire bracket (groups + knockouts) is saved in the URL. Share it with friends!</p>
                <button onclick="copyShareableLink()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold text-sm">
                    &#128279; Copy Shareable Link
                </button>
            </div>
        </div>
    </div>

    <!-- Knockout Bracket Container -->
    <div id="knockout-bracket">
        <div class="empty-state" id="empty-bracket">
            <div class="text-4xl mb-4">&#9917;</div>
            <h3 class="text-xl font-bold mb-2">Complete Group Stage First</h3>
            <p class="text-gray-500 mb-4">Make predictions for all 72 group stage matches to see your knockout bracket.</p>
            <a href="/bracket/groups" class="btn-primary inline-block">Go to Group Stage</a>
        </div>

        <!-- Bracket will be rendered here by JavaScript -->
        <div id="bracket-content" class="hidden">
            <!-- Round of 32 -->
            <div class="round-section" id="round-of-32-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-red-600">Round of 32</h2>
                    <span class="text-sm text-gray-500" id="ro32-progress">0/16 predicted</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3" id="round-of-32-matches"></div>
            </div>

            <!-- Round of 16 -->
            <div class="round-section" id="round-of-16-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-orange-600">Round of 16</h2>
                    <span class="text-sm text-gray-500" id="ro16-progress">0/8 predicted</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3" id="round-of-16-matches"></div>
            </div>

            <!-- Quarter Finals -->
            <div class="round-section" id="quarter-finals-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-yellow-600">Quarter Finals</h2>
                    <span class="text-sm text-gray-500" id="qf-progress">0/4 predicted</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3" id="quarter-finals-matches"></div>
            </div>

            <!-- Semi Finals -->
            <div class="round-section" id="semi-finals-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-purple-600">Semi Finals</h2>
                    <span class="text-sm text-gray-500" id="sf-progress">0/2 predicted</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-xl" id="semi-finals-matches"></div>
            </div>

            <!-- Finals Row -->
            <div class="grid md:grid-cols-2 gap-6 max-w-2xl mt-8">
                <!-- Third Place -->
                <div class="round-section" id="third-place-section">
                    <h2 class="text-xl font-bold text-amber-700 mb-4">&#129353; Third Place Match</h2>
                    <div id="third-place-match"></div>
                </div>

                <!-- Final -->
                <div class="round-section" id="final-section">
                    <h2 class="text-xl font-bold text-fifa-gold mb-4">&#128081; FINAL</h2>
                    <div id="final-match"></div>
                </div>
            </div>

            <!-- Champion Display -->
            <div id="champion-section" class="hidden mt-8 text-center p-8 bg-gradient-to-r from-yellow-100 to-yellow-200 rounded-lg border-2 border-yellow-400">
                <div class="text-4xl mb-2">&#127942;</div>
                <h2 class="text-2xl font-bold text-yellow-800">Your Predicted Champion</h2>
                <div id="champion-display" class="mt-4 text-3xl font-bold"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Data from server
window.teamsByGroup = {{ teams_by_group_json|safe }};
window.allTeams = {{ all_teams_json|safe }};
window.matchData = {{ match_data_json|safe }};

// FIFA 2026 Bracket Structure (48 teams, 12 groups A-L)
// Round of 32 pairings: Group winners vs runners-up from other groups + third place playoffs
const ROUND_OF_32_STRUCTURE = [
    // Left bracket half
    { matchNum: 73, homeSlot: '1A', awaySlot: '2L', label: 'Match 73' },
    { matchNum: 74, homeSlot: '1C', awaySlot: '2J', label: 'Match 74' },
    { matchNum: 75, homeSlot: '1E', awaySlot: '2H', label: 'Match 75' },
    { matchNum: 76, homeSlot: '1G', awaySlot: '2F', label: 'Match 76' },
    { matchNum: 77, homeSlot: '1I', awaySlot: '2D', label: 'Match 77' },
    { matchNum: 78, homeSlot: '1K', awaySlot: '2B', label: 'Match 78' },
    { matchNum: 79, homeSlot: '3rd_1', awaySlot: '3rd_4', label: 'Match 79' },
    { matchNum: 80, homeSlot: '3rd_2', awaySlot: '3rd_3', label: 'Match 80' },
    // Right bracket half
    { matchNum: 81, homeSlot: '1B', awaySlot: '2K', label: 'Match 81' },
    { matchNum: 82, homeSlot: '1D', awaySlot: '2I', label: 'Match 82' },
    { matchNum: 83, homeSlot: '1F', awaySlot: '2G', label: 'Match 83' },
    { matchNum: 84, homeSlot: '1H', awaySlot: '2E', label: 'Match 84' },
    { matchNum: 85, homeSlot: '1J', awaySlot: '2C', label: 'Match 85' },
    { matchNum: 86, homeSlot: '1L', awaySlot: '2A', label: 'Match 86' },
    { matchNum: 87, homeSlot: '3rd_5', awaySlot: '3rd_8', label: 'Match 87' },
    { matchNum: 88, homeSlot: '3rd_6', awaySlot: '3rd_7', label: 'Match 88' },
];

const ROUND_OF_16_STRUCTURE = [
    { matchNum: 89, homeSource: 73, awaySource: 74, label: 'Match 89' },
    { matchNum: 90, homeSource: 75, awaySource: 76, label: 'Match 90' },
    { matchNum: 91, homeSource: 77, awaySource: 78, label: 'Match 91' },
    { matchNum: 92, homeSource: 79, awaySource: 80, label: 'Match 92' },
    { matchNum: 93, homeSource: 81, awaySource: 82, label: 'Match 93' },
    { matchNum: 94, homeSource: 83, awaySource: 84, label: 'Match 94' },
    { matchNum: 95, homeSource: 85, awaySource: 86, label: 'Match 95' },
    { matchNum: 96, homeSource: 87, awaySource: 88, label: 'Match 96' },
];

const QUARTER_FINALS_STRUCTURE = [
    { matchNum: 97, homeSource: 89, awaySource: 90, label: 'QF 1' },
    { matchNum: 98, homeSource: 91, awaySource: 92, label: 'QF 2' },
    { matchNum: 99, homeSource: 93, awaySource: 94, label: 'QF 3' },
    { matchNum: 100, homeSource: 95, awaySource: 96, label: 'QF 4' },
];

const SEMI_FINALS_STRUCTURE = [
    { matchNum: 101, homeSource: 97, awaySource: 98, label: 'SF 1' },
    { matchNum: 102, homeSource: 99, awaySource: 100, label: 'SF 2' },
];

const THIRD_PLACE_STRUCTURE = { matchNum: 103, homeSource: 101, awaySource: 102, isLoser: true, label: '3rd Place' };
const FINAL_STRUCTURE = { matchNum: 104, homeSource: 101, awaySource: 102, label: 'Final' };

// Calculate group standings (same logic as groups.html)
function calculateGroupStandings(groupLetter, teams, predictions) {
    const teamStats = {};

    teams.forEach(team => {
        teamStats[team.id] = {
            team_id: team.id,
            team_name: team.name,
            country_code: team.country_code,
            group: groupLetter,
            played: 0,
            won: 0,
            drawn: 0,
            lost: 0,
            goals_for: 0,
            goals_against: 0,
            points: 0
        };
    });

    Object.entries(predictions).forEach(([matchNum, pred]) => {
        const matchInfo = window.matchData[String(matchNum)] || window.matchData[parseInt(matchNum)];
        if (!matchInfo || matchInfo.group !== groupLetter) return;

        const homeStats = teamStats[matchInfo.homeTeamId];
        const awayStats = teamStats[matchInfo.awayTeamId];
        if (!homeStats || !awayStats) return;

        homeStats.played++;
        awayStats.played++;

        const homeScore = pred.homeScore || 0;
        const awayScore = pred.awayScore || 0;

        homeStats.goals_for += homeScore;
        homeStats.goals_against += awayScore;
        awayStats.goals_for += awayScore;
        awayStats.goals_against += homeScore;

        if (pred.outcome === 'home_win') {
            homeStats.won++;
            homeStats.points += 3;
            awayStats.lost++;
        } else if (pred.outcome === 'away_win') {
            awayStats.won++;
            awayStats.points += 3;
            homeStats.lost++;
        } else {
            homeStats.drawn++;
            awayStats.drawn++;
            homeStats.points++;
            awayStats.points++;
        }
    });

    return Object.values(teamStats)
        .map(s => ({ ...s, goal_diff: s.goals_for - s.goals_against }))
        .sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.goal_diff !== a.goal_diff) return b.goal_diff - a.goal_diff;
            return b.goals_for - a.goals_for;
        });
}

// Get all qualifying teams from group predictions
function getQualifyingTeams() {
    const predictions = window.bracketState.groupPredictions || {};
    const qualifiers = {
        groupWinners: {},      // 1A, 1B, etc.
        groupRunnersUp: {},    // 2A, 2B, etc.
        thirdPlace: []         // Sorted best to worst
    };

    const groupLetters = Object.keys(window.teamsByGroup).sort();

    groupLetters.forEach(group => {
        const teams = window.teamsByGroup[group];
        const standings = calculateGroupStandings(group, teams, predictions);

        if (standings.length >= 1 && standings[0].played > 0) {
            qualifiers.groupWinners[`1${group}`] = standings[0];
        }
        if (standings.length >= 2 && standings[1].played > 0) {
            qualifiers.groupRunnersUp[`2${group}`] = standings[1];
        }
        if (standings.length >= 3) {
            qualifiers.thirdPlace.push({ ...standings[2], group: group });
        }
    });

    // Sort third place teams and take best 8
    qualifiers.thirdPlace.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.goal_diff !== a.goal_diff) return b.goal_diff - a.goal_diff;
        return b.goals_for - a.goals_for;
    });

    // Apply user's manual third place ranking if exists
    if (window.bracketState.thirdPlaceRanking && window.bracketState.thirdPlaceRanking.length > 0) {
        const rankedTeams = [];
        const unrankedTeams = [...qualifiers.thirdPlace];

        window.bracketState.thirdPlaceRanking.forEach(teamId => {
            const idx = unrankedTeams.findIndex(t => t.team_id === teamId);
            if (idx !== -1) {
                rankedTeams.push(unrankedTeams.splice(idx, 1)[0]);
            }
        });

        qualifiers.thirdPlace = [...rankedTeams, ...unrankedTeams];
    }

    return qualifiers;
}

// Get team for a slot position
function getTeamForSlot(slot, qualifiers) {
    if (slot.startsWith('1')) {
        return qualifiers.groupWinners[slot] || null;
    } else if (slot.startsWith('2')) {
        return qualifiers.groupRunnersUp[slot] || null;
    } else if (slot.startsWith('3rd_')) {
        const rank = parseInt(slot.split('_')[1]) - 1;
        return qualifiers.thirdPlace[rank] || null;
    }
    return null;
}

// Get winner of a knockout match
function getMatchWinner(matchNum, isLoserMatch = false) {
    const pred = window.bracketState.knockoutPredictions[matchNum];
    if (!pred) return null;

    // Get the teams that played in this match
    const matchTeams = window.knockoutMatchTeams[matchNum];
    if (!matchTeams) return null;

    if (isLoserMatch) {
        // For third place match, get the loser
        if (pred.outcome === 'home_win') return matchTeams.away;
        if (pred.outcome === 'away_win') return matchTeams.home;
    } else {
        if (pred.outcome === 'home_win') return matchTeams.home;
        if (pred.outcome === 'away_win') return matchTeams.away;
        if (pred.outcome === 'draw' && pred.penaltyWinner) {
            return matchTeams.home?.team_id === pred.penaltyWinner ? matchTeams.home : matchTeams.away;
        }
    }
    return null;
}

// Store computed match teams for later rounds
window.knockoutMatchTeams = {};

// Render a match card
function renderMatchCard(matchNum, homeTeam, awayTeam, homeSlot, awaySlot, label) {
    // Store teams for this match
    window.knockoutMatchTeams[matchNum] = { home: homeTeam, away: awayTeam };

    const pred = window.bracketState.knockoutPredictions[matchNum];
    const hasPrediction = !!pred;

    const homeClass = pred?.outcome === 'home_win' ? 'winner' : (pred?.outcome === 'away_win' ? 'loser' : '');
    const awayClass = pred?.outcome === 'away_win' ? 'winner' : (pred?.outcome === 'home_win' ? 'loser' : '');

    const homeDisplay = homeTeam
        ? `<img src="https://flagcdn.com/w40/${homeTeam.country_code.toLowerCase()}.png" class="team-flag" alt="${homeTeam.country_code}">
           <span class="font-medium">${homeTeam.team_name}</span>`
        : `<span class="text-gray-400">${homeSlot || 'TBD'}</span>`;

    const awayDisplay = awayTeam
        ? `<img src="https://flagcdn.com/w40/${awayTeam.country_code.toLowerCase()}.png" class="team-flag" alt="${awayTeam.country_code}">
           <span class="font-medium">${awayTeam.team_name}</span>`
        : `<span class="text-gray-400">${awaySlot || 'TBD'}</span>`;

    return `
        <div class="match-card p-3 ${hasPrediction ? 'has-prediction' : ''}" data-match-number="${matchNum}">
            <div class="text-xs text-gray-500 mb-2">${label}</div>
            <div class="space-y-1">
                <div class="team-slot ${homeTeam ? '' : 'tbd'} ${homeClass}"
                     onclick="selectKnockoutWinner(${matchNum}, 'home')"
                     ${!homeTeam ? 'style="pointer-events: none;"' : ''}>
                    ${homeDisplay}
                </div>
                <div class="vs-badge mx-auto w-8">VS</div>
                <div class="team-slot ${awayTeam ? '' : 'tbd'} ${awayClass}"
                     onclick="selectKnockoutWinner(${matchNum}, 'away')"
                     ${!awayTeam ? 'style="pointer-events: none;"' : ''}>
                    ${awayDisplay}
                </div>
            </div>
        </div>
    `;
}

// Select knockout winner
function selectKnockoutWinner(matchNum, side) {
    const matchTeams = window.knockoutMatchTeams[matchNum];
    if (!matchTeams) return;

    const winner = side === 'home' ? matchTeams.home : matchTeams.away;
    if (!winner) return;

    const outcome = side === 'home' ? 'home_win' : 'away_win';
    const winnerId = winner.team_id;

    // Save prediction
    window.bracketState.knockoutPredictions[matchNum] = {
        outcome: outcome,
        homeScore: null,
        awayScore: null,
        penaltyWinner: winnerId
    };

    updateURLState();
    renderBracket();
}

// Count group stage predictions
function countGroupPredictions() {
    return Object.keys(window.bracketState.groupPredictions || {}).length;
}

// Render the entire bracket
function renderBracket() {
    const predictionCount = countGroupPredictions();
    const totalGroupMatches = 72;
    const percentage = Math.round((predictionCount / totalGroupMatches) * 100);

    // Update progress bar
    document.getElementById('prediction-progress').textContent = `${predictionCount}/${totalGroupMatches} matches`;
    document.getElementById('progress-fill').style.width = `${percentage}%`;

    if (predictionCount < totalGroupMatches) {
        document.getElementById('progress-message').textContent =
            `Complete ${totalGroupMatches - predictionCount} more group stage predictions to see the knockout bracket.`;
        document.getElementById('empty-bracket').classList.remove('hidden');
        document.getElementById('bracket-content').classList.add('hidden');
        document.getElementById('champion-section').classList.add('hidden');
        return;
    }

    document.getElementById('progress-message').textContent = 'All group stage predictions complete! Your knockout bracket is ready.';
    document.getElementById('empty-bracket').classList.add('hidden');
    document.getElementById('bracket-content').classList.remove('hidden');

    const qualifiers = getQualifyingTeams();

    // Render Round of 32
    let ro32Html = '';
    ROUND_OF_32_STRUCTURE.forEach(match => {
        const homeTeam = getTeamForSlot(match.homeSlot, qualifiers);
        const awayTeam = getTeamForSlot(match.awaySlot, qualifiers);
        ro32Html += renderMatchCard(match.matchNum, homeTeam, awayTeam, match.homeSlot, match.awaySlot, match.label);
    });
    document.getElementById('round-of-32-matches').innerHTML = ro32Html;

    // Render Round of 16
    let ro16Html = '';
    ROUND_OF_16_STRUCTURE.forEach(match => {
        const homeTeam = getMatchWinner(match.homeSource);
        const awayTeam = getMatchWinner(match.awaySource);
        const homeSlot = `W${match.homeSource}`;
        const awaySlot = `W${match.awaySource}`;
        ro16Html += renderMatchCard(match.matchNum, homeTeam, awayTeam, homeSlot, awaySlot, match.label);
    });
    document.getElementById('round-of-16-matches').innerHTML = ro16Html;

    // Render Quarter Finals
    let qfHtml = '';
    QUARTER_FINALS_STRUCTURE.forEach(match => {
        const homeTeam = getMatchWinner(match.homeSource);
        const awayTeam = getMatchWinner(match.awaySource);
        const homeSlot = `W${match.homeSource}`;
        const awaySlot = `W${match.awaySource}`;
        qfHtml += renderMatchCard(match.matchNum, homeTeam, awayTeam, homeSlot, awaySlot, match.label);
    });
    document.getElementById('quarter-finals-matches').innerHTML = qfHtml;

    // Render Semi Finals
    let sfHtml = '';
    SEMI_FINALS_STRUCTURE.forEach(match => {
        const homeTeam = getMatchWinner(match.homeSource);
        const awayTeam = getMatchWinner(match.awaySource);
        const homeSlot = `W${match.homeSource}`;
        const awaySlot = `W${match.awaySource}`;
        sfHtml += renderMatchCard(match.matchNum, homeTeam, awayTeam, homeSlot, awaySlot, match.label);
    });
    document.getElementById('semi-finals-matches').innerHTML = sfHtml;

    // Render Third Place Match (losers of semis)
    const thirdPlaceHome = getMatchWinner(THIRD_PLACE_STRUCTURE.homeSource, true);
    const thirdPlaceAway = getMatchWinner(THIRD_PLACE_STRUCTURE.awaySource, true);
    document.getElementById('third-place-match').innerHTML = renderMatchCard(
        THIRD_PLACE_STRUCTURE.matchNum,
        thirdPlaceHome,
        thirdPlaceAway,
        `L${THIRD_PLACE_STRUCTURE.homeSource}`,
        `L${THIRD_PLACE_STRUCTURE.awaySource}`,
        THIRD_PLACE_STRUCTURE.label
    );

    // Render Final
    const finalHome = getMatchWinner(FINAL_STRUCTURE.homeSource);
    const finalAway = getMatchWinner(FINAL_STRUCTURE.awaySource);
    document.getElementById('final-match').innerHTML = renderMatchCard(
        FINAL_STRUCTURE.matchNum,
        finalHome,
        finalAway,
        `W${FINAL_STRUCTURE.homeSource}`,
        `W${FINAL_STRUCTURE.awaySource}`,
        FINAL_STRUCTURE.label
    );

    // Show champion if final is predicted
    const champion = getMatchWinner(104);
    if (champion) {
        document.getElementById('champion-section').classList.remove('hidden');
        document.getElementById('champion-display').innerHTML = `
            <img src="https://flagcdn.com/w80/${champion.country_code.toLowerCase()}.png"
                 class="inline-block w-16 h-10 object-cover rounded mr-3" alt="${champion.country_code}">
            ${champion.team_name}
        `;
    } else {
        document.getElementById('champion-section').classList.add('hidden');
    }

    // Update progress counters
    updateProgressCounters();
}

// Update round progress counters
function updateProgressCounters() {
    const koPreds = window.bracketState.knockoutPredictions || {};

    const ro32Count = ROUND_OF_32_STRUCTURE.filter(m => koPreds[m.matchNum]).length;
    const ro16Count = ROUND_OF_16_STRUCTURE.filter(m => koPreds[m.matchNum]).length;
    const qfCount = QUARTER_FINALS_STRUCTURE.filter(m => koPreds[m.matchNum]).length;
    const sfCount = SEMI_FINALS_STRUCTURE.filter(m => koPreds[m.matchNum]).length;

    document.getElementById('ro32-progress').textContent = `${ro32Count}/16 predicted`;
    document.getElementById('ro16-progress').textContent = `${ro16Count}/8 predicted`;
    document.getElementById('qf-progress').textContent = `${qfCount}/4 predicted`;
    document.getElementById('sf-progress').textContent = `${sfCount}/2 predicted`;
}

// Decode state from URL (independent of app.js)
function loadBracketStateFromURL() {
    const params = new URLSearchParams(window.location.search);
    const stateParam = params.get('s');

    if (stateParam) {
        try {
            // Decode base64url
            let str = stateParam.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            const compressed = new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));

            // Decompress with pako
            const json = pako.inflate(compressed, { to: 'string' });
            const state = JSON.parse(json);

            console.log('Loaded state from URL:', state);
            return state;
        } catch (e) {
            console.error('Failed to decode state:', e);
        }
    }

    return {
        version: 1,
        groupPredictions: {},
        knockoutPredictions: {},
        thirdPlaceRanking: []
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load state from URL
    window.bracketState = loadBracketStateFromURL();

    console.log('Knockout page - Group predictions count:', Object.keys(window.bracketState?.groupPredictions || {}).length);
    renderBracket();
});
</script>
{% endblock %}
