{% extends "base.html" %}

{% block title %}Knockout Bracket - FIFA World Cup 2026{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Knockout Bracket</h1>

    {% if not bracket %}
        <div class="card text-center py-12">
            <p class="text-gray-500 mb-4">Complete your group stage predictions first.</p>
            <a href="/bracket/groups" class="btn-primary">Go to Groups</a>
        </div>
    {% else %}
        <!-- Round of 32 -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Round of 32</h2>
            <div class="grid md:grid-cols-4 gap-4">
                {% for match in bracket.round_of_32 %}
                    <div class="match-card">
                        <div class="text-xs text-gray-500 mb-2">Match {{ match.match_number }}</div>

                        <div class="space-y-2">
                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 transition-all {{ 'border-fifa-blue bg-blue-50' if match.prediction and match.prediction.predicted_winner_team_id == match.home_team.team_id else 'border-gray-200 hover:border-fifa-blue' }}"
                                onclick="selectKnockoutWinner({{ match.match_number }}, {{ match.home_team.team_id if match.home_team else 'null' }})"
                                {{ 'disabled' if not match.home_team or match.locked }}
                            >
                                <span class="text-xl">{{ match.home_team.flag_emoji if match.home_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.home_team.team_name if match.home_team else 'TBD' }}</span>
                            </button>

                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 transition-all {{ 'border-fifa-blue bg-blue-50' if match.prediction and match.prediction.predicted_winner_team_id == match.away_team.team_id else 'border-gray-200 hover:border-fifa-blue' }}"
                                onclick="selectKnockoutWinner({{ match.match_number }}, {{ match.away_team.team_id if match.away_team else 'null' }})"
                                {{ 'disabled' if not match.away_team or match.locked }}
                            >
                                <span class="text-xl">{{ match.away_team.flag_emoji if match.away_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.away_team.team_name if match.away_team else 'TBD' }}</span>
                            </button>
                        </div>

                        {% if match.locked %}
                            <div class="text-xs text-gray-400 text-center mt-2">Locked</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Round of 16 -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Round of 16</h2>
            <div class="grid md:grid-cols-4 gap-4">
                {% for match in bracket.round_of_16 %}
                    <div class="match-card">
                        <div class="text-xs text-gray-500 mb-2">Match {{ match.match_number }}</div>
                        <div class="space-y-2">
                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 {{ 'border-fifa-blue bg-blue-50' if match.prediction and match.prediction.predicted_winner_team_id == match.home_team.team_id else 'border-gray-200 hover:border-fifa-blue' }}"
                                onclick="selectKnockoutWinner({{ match.match_number }}, {{ match.home_team.team_id if match.home_team else 'null' }})"
                                {{ 'disabled' if not match.home_team }}
                            >
                                <span class="text-xl">{{ match.home_team.flag_emoji if match.home_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.home_team.team_name if match.home_team else 'Winner R32' }}</span>
                            </button>
                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 {{ 'border-fifa-blue bg-blue-50' if match.prediction and match.prediction.predicted_winner_team_id == match.away_team.team_id else 'border-gray-200 hover:border-fifa-blue' }}"
                                onclick="selectKnockoutWinner({{ match.match_number }}, {{ match.away_team.team_id if match.away_team else 'null' }})"
                                {{ 'disabled' if not match.away_team }}
                            >
                                <span class="text-xl">{{ match.away_team.flag_emoji if match.away_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.away_team.team_name if match.away_team else 'Winner R32' }}</span>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Quarter Finals -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Quarter Finals</h2>
            <div class="grid md:grid-cols-4 gap-4">
                {% for match in bracket.quarter_finals %}
                    <div class="match-card">
                        <div class="text-xs text-gray-500 mb-2">Match {{ match.match_number }}</div>
                        <div class="space-y-2">
                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 {{ 'border-fifa-blue bg-blue-50' if match.prediction else 'border-gray-200 hover:border-fifa-blue' }}"
                                {{ 'disabled' if not match.home_team }}
                            >
                                <span class="text-xl">{{ match.home_team.flag_emoji if match.home_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.home_team.team_name if match.home_team else 'Winner R16' }}</span>
                            </button>
                            <button
                                class="w-full p-2 rounded border-2 flex items-center gap-2 {{ 'border-gray-200 hover:border-fifa-blue' }}"
                                {{ 'disabled' if not match.away_team }}
                            >
                                <span class="text-xl">{{ match.away_team.flag_emoji if match.away_team else 'üè≥Ô∏è' }}</span>
                                <span class="flex-1 text-left">{{ match.away_team.team_name if match.away_team else 'Winner R16' }}</span>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Semi Finals, Third Place, Final -->
        <div class="grid md:grid-cols-3 gap-6">
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Semi Finals</h2>
                {% for match in bracket.semi_finals %}
                    <div class="match-card mb-4">
                        <div class="space-y-2">
                            <div class="p-2 border rounded">{{ match.home_team.team_name if match.home_team else 'Winner QF' }}</div>
                            <div class="p-2 border rounded">{{ match.away_team.team_name if match.away_team else 'Winner QF' }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4">Third Place Match</h2>
                {% if bracket.third_place_match %}
                    <div class="match-card">
                        <div class="space-y-2">
                            <div class="p-2 border rounded">{{ bracket.third_place_match.home_team.team_name if bracket.third_place_match.home_team else 'Loser SF' }}</div>
                            <div class="p-2 border rounded">{{ bracket.third_place_match.away_team.team_name if bracket.third_place_match.away_team else 'Loser SF' }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="card bg-fifa-gold">
                <h2 class="text-xl font-bold mb-4 text-fifa-dark">Final</h2>
                {% if bracket.final %}
                    <div class="bg-white rounded p-4">
                        <div class="space-y-2">
                            <div class="p-2 border-2 border-fifa-gold rounded">{{ bracket.final.home_team.team_name if bracket.final.home_team else 'Winner SF' }}</div>
                            <div class="p-2 border-2 border-fifa-gold rounded">{{ bracket.final.away_team.team_name if bracket.final.away_team else 'Winner SF' }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<script>
async function selectKnockoutWinner(matchNumber, teamId) {
    if (!teamId) return;

    // Find match ID from match number
    const response = await fetch(`/api/predictions/match-by-number/${matchNumber}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            predicted_outcome: 'home_win', // Will be determined by which team
            predicted_winner_team_id: teamId
        })
    });

    if (response.ok) {
        showToast('Prediction saved!', 'success');
        setTimeout(() => location.reload(), 500);
    }
}
</script>
{% endblock %}
