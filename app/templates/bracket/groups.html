{% extends "base.html" %}
{% from "components/team_flag.html" import flag %}

{% block title %}Group Stage - FIFA World Cup 2026{% endblock %}

{% block head %}
<style>
    .draggable {
        cursor: move;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .draggable:hover {
        transform: scale(1.02);
    }
    .draggable.dragging {
        opacity: 0.5;
        transform: scale(1.05);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .drag-over {
        border: 2px dashed #326295;
    }
    .prediction-btn.selected {
        background-color: #326295;
        color: white;
        border-color: #326295;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Group Stage Predictions</h1>

    <!-- Instructions Banner -->
    <div class="bg-gradient-to-r from-slate-200 to-slate-300 text-slate-900 rounded-lg p-6 mb-8 shadow-md border border-slate-400">
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">&#128203;</span> How to Fill Your Bracket
                </h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="font-semibold mb-1">&#127919; Predict Match Outcomes:</p>
                        <ul class="ml-4 space-y-1 list-disc">
                            <li><strong>H</strong> = Home team wins</li>
                            <li><strong>D</strong> = Draw</li>
                            <li><strong>A</strong> = Away team wins</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">&#128202; Optional Scores:</p>
                        <p>Enter predicted scores (home-away) for more precise predictions.</p>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">&#127942;</span> How It Works
                </h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="font-semibold mb-1">&#128279; URL-Based Saving:</p>
                        <p>Your predictions are saved in the URL. Bookmark or share the link to save your bracket!</p>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">&#129353; Third-Place Qualification:</p>
                        <p>Top 2 teams per group auto-qualify. Best 8 of 12 third-place teams also advance.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not groups %}
        <div class="card text-center py-12">
            <p class="text-gray-500 mb-4">No groups have been set up yet.</p>
            <p class="text-sm text-gray-400">Check back when the tournament draw is complete.</p>
        </div>
    {% else %}
        <!-- Action Buttons -->
        <div class="mb-6 flex gap-3 justify-center">
            <button
                id="autoSelectAllBtn"
                onclick="autoSelectAllGroups()"
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2 cursor-pointer"
            >
                <span>&#9889; Auto-Select All Groups</span>
            </button>
            <button
                onclick="resetAllPredictions()"
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2 cursor-pointer"
            >
                <span>&#128260; Reset All</span>
            </button>
            <button
                onclick="copyShareableLink()"
                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2 cursor-pointer"
            >
                <span>&#128279; Share Bracket</span>
            </button>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for group_letter, group_data in groups.items() %}
                <div class="card" data-group="{{ group_letter }}">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-fifa-blue">Group {{ group_letter }}</h2>
                        <button
                            onclick="autoSelectGroup('{{ group_letter }}')"
                            class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded font-semibold transition"
                        >
                            &#9889; Select
                        </button>
                    </div>

                    <!-- Standings Table -->
                    <div class="mb-4">
                        <table class="w-full text-sm" id="standings-{{ group_letter }}">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-1">#</th>
                                    <th class="text-left py-1">Team</th>
                                    <th class="text-center py-1">P</th>
                                    <th class="text-center py-1">GF</th>
                                    <th class="text-center py-1">GA</th>
                                    <th class="text-center py-1">GD</th>
                                    <th class="text-center py-1">Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in group_data.teams %}
                                    <tr class="border-b" data-team-id="{{ team.id }}">
                                        <td class="py-1 rank-cell">{{ loop.index }}</td>
                                        <td class="py-1">
                                            {{ flag(team.country_code, 16) }}
                                            <span class="ml-1">{{ team.country_code }}</span>
                                        </td>
                                        <td class="text-center py-1 played-cell">0</td>
                                        <td class="text-center py-1 gf-cell">0</td>
                                        <td class="text-center py-1 ga-cell">0</td>
                                        <td class="text-center py-1 gd-cell">0</td>
                                        <td class="text-center py-1 font-bold pts-cell">0</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="text-xs text-gray-500 mt-2">
                            <span class="inline-block w-3 h-3 bg-green-100 border mr-1"></span> Qualifies
                            <span class="inline-block w-3 h-3 bg-yellow-100 border ml-2 mr-1"></span> Third place
                        </div>
                    </div>

                    <!-- Matches -->
                    <div class="space-y-2">
                        {% for match in group_data.matches %}
                            <div class="match-card p-2 text-sm border rounded"
                                 data-match-number="{{ match.match_number }}"
                                 data-home-team-id="{{ match.home_team_id }}"
                                 data-away-team-id="{{ match.away_team_id }}"
                                 data-group="{{ group_letter }}">
                                <div class="text-xs text-gray-500 mt-1 mb-2">
                                    {% if match.scheduled_datetime %}
                                        <span>{{ match.scheduled_datetime.strftime('%b %d, %Y %H:%M') }}</span>
                                    {% endif %}
                                    {% if match.stadium %}
                                        <span class="ml-1">&#8226; {{ match.stadium.city }}</span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1">
                                        {{ flag(match.home_team.country_code, 16) }}
                                        <span class="truncate w-20">{{ match.home_team.name }}</span>
                                    </div>

                                    <div class="flex gap-1">
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 border rounded"
                                            data-outcome="home_win"
                                            onclick="handlePrediction({{ match.match_number }}, 'home_win')"
                                        >
                                            H
                                        </button>
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 border rounded"
                                            data-outcome="draw"
                                            onclick="handlePrediction({{ match.match_number }}, 'draw')"
                                        >
                                            D
                                        </button>
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 border rounded"
                                            data-outcome="away_win"
                                            onclick="handlePrediction({{ match.match_number }}, 'away_win')"
                                        >
                                            A
                                        </button>
                                    </div>

                                    <div class="flex items-center gap-1">
                                        <span class="truncate w-20 text-right">{{ match.away_team.name }}</span>
                                        {{ flag(match.away_team.country_code, 16) }}
                                    </div>
                                </div>

                                <div class="flex items-center justify-center gap-2 mt-2">
                                    <input
                                        type="number"
                                        min="0"
                                        max="20"
                                        class="home-score w-12 text-center input-field text-xs py-1 border rounded"
                                        placeholder="-"
                                        onchange="handleScoreChange({{ match.match_number }})"
                                    >
                                    <span class="text-gray-400">-</span>
                                    <input
                                        type="number"
                                        min="0"
                                        max="20"
                                        class="away-score w-12 text-center input-field text-xs py-1 border rounded"
                                        placeholder="-"
                                        onchange="handleScoreChange({{ match.match_number }})"
                                    >
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 text-center">
                        <span class="text-sm text-gray-500 predictions-count">
                            0/{{ group_data.matches|length }} predicted
                        </span>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Third Place Ranking Section -->
        <div class="mt-12 border-t pt-8">
            <h2 class="text-2xl font-bold mb-4">Third Place Ranking</h2>
            <p class="text-gray-600 mb-6">
                Drag and drop to reorder. The top 8 teams will qualify for the Round of 32.
            </p>

            <div class="max-w-4xl mx-auto">
                <div class="card">
                    <div id="ranking-list" class="space-y-2">
                        <!-- Will be populated by JavaScript based on standings -->
                        <p class="text-gray-500 text-center py-4">Make predictions above to see third-place teams</p>
                    </div>

                    <div class="mt-4 p-3 bg-gray-100 rounded text-sm text-gray-600">
                        <span class="inline-block w-4 h-4 bg-green-500 rounded mr-1"></span>
                        Teams 1-8 qualify for Round of 32
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="goToKnockout()" class="btn-primary text-lg px-8 py-3 inline-block cursor-pointer">
                        Go to Knockout Phase &rarr;
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Initialize match data from server
window.matchData = {{ match_data_json|safe }};

// Group teams data for standings calculation
window.groupTeams = {
    {% for group_letter, group_data in groups.items() %}
    '{{ group_letter }}': [
        {% for team in group_data.teams %}
        { id: {{ team.id }}, name: '{{ team.name }}', country_code: '{{ team.country_code }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Handle prediction button click
function handlePrediction(matchNumber, outcome) {
    const matchCard = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchCard) return;

    // Get scores if entered
    const homeScoreInput = matchCard.querySelector('.home-score');
    const awayScoreInput = matchCard.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    // Update UI
    selectPrediction(matchNumber, outcome);

    // Save to local state and URL
    savePredictionLocal(matchNumber, outcome, homeScore, awayScore);

    // Recalculate standings
    recalculateAllStandings();
}

// Handle score input change
function handleScoreChange(matchNumber) {
    const matchCard = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchCard) return;

    const homeScoreInput = matchCard.querySelector('.home-score');
    const awayScoreInput = matchCard.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    // Determine outcome from scores
    let outcome = null;
    if (homeScore !== null && awayScore !== null) {
        if (homeScore > awayScore) outcome = 'home_win';
        else if (awayScore > homeScore) outcome = 'away_win';
        else outcome = 'draw';

        // Update UI
        selectPrediction(matchNumber, outcome);
    }

    // Get current prediction or use calculated outcome
    const currentPred = window.bracketState.groupPredictions[matchNumber];
    const finalOutcome = outcome || (currentPred ? currentPred.outcome : null);

    if (finalOutcome) {
        savePredictionLocal(matchNumber, finalOutcome, homeScore, awayScore, null, true);
        recalculateAllStandings();
    }
}

// Auto-select all groups with random outcomes
async function autoSelectAllGroups() {
    const matchCards = document.querySelectorAll('[data-match-number]');
    console.log(`Found ${matchCards.length} total match cards in DOM`);
    
    let selectedCount = 0;
    const processedMatches = [];

    matchCards.forEach(card => {
        const matchNumber = parseInt(card.dataset.matchNumber);
        
        if (matchNumber <= 72) { // Only group stage
            const outcomes = ['home_win', 'draw', 'away_win'];
            const randomOutcome = outcomes[Math.floor(Math.random() * 3)];

            // Generate random scores matching outcome
            let homeScore, awayScore;
            if (randomOutcome === 'home_win') {
                homeScore = Math.floor(Math.random() * 4) + 1;
                awayScore = Math.floor(Math.random() * homeScore);
            } else if (randomOutcome === 'away_win') {
                awayScore = Math.floor(Math.random() * 4) + 1;
                homeScore = Math.floor(Math.random() * awayScore);
            } else {
                homeScore = awayScore = Math.floor(Math.random() * 4);
            }

            // Update UI
            selectPrediction(matchNumber, randomOutcome);
            card.querySelector('.home-score').value = homeScore;
            card.querySelector('.away-score').value = awayScore;

            // Save
            savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
            selectedCount++;
            processedMatches.push(matchNumber);
        }
    });

    console.log(`Auto-selected ${selectedCount} group stage matches`);
    console.log(`Match numbers processed: ${processedMatches.join(', ')}`);
    console.log(`Current groupPredictions state:`, window.bracketState.groupPredictions);
    
    // Ensure state is updated properly
    updateURLState();
    
    // Small delay to ensure recalculation happens after state is updated
    await new Promise(resolve => setTimeout(resolve, 50));
    
    console.log(`About to recalculate standings...`);
    recalculateAllStandings();
    showToast(`All groups auto-selected! (${selectedCount} matches)`, 'success');
}

// Auto-select a single group
async function autoSelectGroup(groupLetter) {
    const groupCard = document.querySelector(`[data-group="${groupLetter}"]`);
    if (!groupCard) return;

    const matchCards = groupCard.querySelectorAll('[data-match-number]');
    let selectedCount = 0;

    matchCards.forEach(card => {
        const matchNumber = parseInt(card.dataset.matchNumber);
        const outcomes = ['home_win', 'draw', 'away_win'];
        const randomOutcome = outcomes[Math.floor(Math.random() * 3)];

        // Generate random scores
        let homeScore, awayScore;
        if (randomOutcome === 'home_win') {
            homeScore = Math.floor(Math.random() * 4) + 1;
            awayScore = Math.floor(Math.random() * homeScore);
        } else if (randomOutcome === 'away_win') {
            awayScore = Math.floor(Math.random() * 4) + 1;
            homeScore = Math.floor(Math.random() * awayScore);
        } else {
            homeScore = awayScore = Math.floor(Math.random() * 4);
        }

        selectPrediction(matchNumber, randomOutcome);
        card.querySelector('.home-score').value = homeScore;
        card.querySelector('.away-score').value = awayScore;

        savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
        selectedCount++;
    });

    console.log(`Auto-selected ${selectedCount} matches in group ${groupLetter}`);
    
    // Ensure state is updated properly
    updateURLState();
    
    // Small delay to ensure recalculation happens after state is updated
    await new Promise(resolve => setTimeout(resolve, 50));
    
    recalculateAllStandings();
    showToast(`Group ${groupLetter} auto-selected! (${selectedCount} matches)`, 'success');
}

// Recalculate all group standings
function recalculateAllStandings() {
    console.log(`recalculateAllStandings called with predictions:`, window.bracketState.groupPredictions);
    const groupLetters = Object.keys(window.groupTeams);
    const thirdPlaceTeams = [];

    groupLetters.forEach(group => {
        console.log(`Calculating standings for group ${group}...`);
        const standings = calculateGroupStandings(group, window.groupTeams[group], window.bracketState.groupPredictions);
        console.log(`Group ${group} standings:`, standings);
        updateStandingsUI(group, standings);

        // Track third place team
        if (standings.length >= 3) {
            thirdPlaceTeams.push({
                ...standings[2],
                group: group
            });
        }
    });

    // Update prediction counts
    updatePredictionCounts();

    // Update third place ranking
    updateThirdPlaceRanking(thirdPlaceTeams);
}

// Update standings table UI
function updateStandingsUI(groupLetter, standings) {
    const table = document.getElementById(`standings-${groupLetter}`);
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');

    // Sort rows by standings order
    standings.forEach((team, index) => {
        const row = tbody.querySelector(`tr[data-team-id="${team.team_id}"]`);
        if (row) {
            row.querySelector('.rank-cell').textContent = index + 1;
            row.querySelector('.played-cell').textContent = team.played;
            row.querySelector('.gf-cell').textContent = team.goals_for;
            row.querySelector('.ga-cell').textContent = team.goals_against;
            row.querySelector('.gd-cell').textContent = team.goal_diff;
            row.querySelector('.pts-cell').textContent = team.points;

            // Update row styling
            row.className = 'border-b';
            if (index < 2) {
                row.classList.add('bg-green-50');
            } else if (index === 2) {
                row.classList.add('bg-yellow-50');
            }

            // Move row to correct position
            tbody.appendChild(row);
        }
    });
}

// Update prediction counts for each group
function updatePredictionCounts() {
    document.querySelectorAll('[data-group]').forEach(groupCard => {
        const matchCards = groupCard.querySelectorAll('[data-match-number]');
        let predictedCount = 0;

        matchCards.forEach(card => {
            const matchNumber = card.dataset.matchNumber;
            if (window.bracketState.groupPredictions[matchNumber]) {
                predictedCount++;
            }
        });

        const countEl = groupCard.querySelector('.predictions-count');
        if (countEl) {
            countEl.textContent = `${predictedCount}/${matchCards.length} predicted`;
        }
    });
}

// Update third place ranking UI
function updateThirdPlaceRanking(thirdPlaceTeams) {
    const rankingList = document.getElementById('ranking-list');
    if (!rankingList) return;

    // Sort by points, goal diff, goals for
    thirdPlaceTeams.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.goal_diff !== a.goal_diff) return b.goal_diff - a.goal_diff;
        return b.goals_for - a.goals_for;
    });

    // Apply user's manual ranking if exists
    if (window.bracketState.thirdPlaceRanking && window.bracketState.thirdPlaceRanking.length > 0) {
        const rankedTeams = [];
        const unrankedTeams = [...thirdPlaceTeams];

        window.bracketState.thirdPlaceRanking.forEach(teamId => {
            const idx = unrankedTeams.findIndex(t => t.team_id === teamId);
            if (idx !== -1) {
                rankedTeams.push(unrankedTeams.splice(idx, 1)[0]);
            }
        });

        thirdPlaceTeams.length = 0;
        thirdPlaceTeams.push(...rankedTeams, ...unrankedTeams);
    }

    if (thirdPlaceTeams.length === 0) {
        rankingList.innerHTML = '<p class="text-gray-500 text-center py-4">Make predictions above to see third-place teams</p>';
        return;
    }

    rankingList.innerHTML = thirdPlaceTeams.map((team, index) => `
        <div
            class="draggable flex items-center justify-between p-3 bg-white border rounded-lg ${index < 8 ? 'border-green-500 bg-green-50' : 'border-gray-200'}"
            data-team-id="${team.team_id}"
            draggable="true"
        >
            <div class="flex items-center gap-4">
                <span class="w-8 h-8 flex items-center justify-center rounded-full ${index < 8 ? 'bg-green-500 text-white' : 'bg-gray-200'} font-bold">
                    ${index + 1}
                </span>
                <div>
                    <div class="font-medium">${team.team_name}</div>
                    <div class="text-sm text-gray-500">Group ${team.group}</div>
                </div>
            </div>
            <div class="flex gap-6 text-sm">
                <div class="text-center">
                    <div class="font-bold">${team.points}</div>
                    <div class="text-gray-500">Pts</div>
                </div>
                <div class="text-center">
                    <div class="font-bold">${team.goal_diff}</div>
                    <div class="text-gray-500">GD</div>
                </div>
                <div class="text-center">
                    <div class="font-bold">${team.goals_for}</div>
                    <div class="text-gray-500">GF</div>
                </div>
            </div>
        </div>
    `).join('');

    // Re-attach drag and drop handlers
    initDragAndDrop();
}

// Initialize drag and drop for third place ranking
function initDragAndDrop() {
    const list = document.getElementById('ranking-list');
    if (!list) return;

    let draggedItem = null;

    list.querySelectorAll('.draggable').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.classList.add('dragging');
        });

        item.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            saveThirdPlaceOrder();
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        item.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedItem !== this) {
                const allItems = [...list.querySelectorAll('.draggable')];
                const draggedIdx = allItems.indexOf(draggedItem);
                const targetIdx = allItems.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }

                updateRankBadges();
            }
        });
    });
}

// Update rank badges after reordering
function updateRankBadges() {
    const items = document.querySelectorAll('#ranking-list .draggable');
    items.forEach((item, index) => {
        const rankBadge = item.querySelector('span:first-child');
        rankBadge.textContent = index + 1;

        if (index < 8) {
            item.classList.add('border-green-500', 'bg-green-50');
            item.classList.remove('border-gray-200');
            rankBadge.classList.add('bg-green-500', 'text-white');
            rankBadge.classList.remove('bg-gray-200');
        } else {
            item.classList.remove('border-green-500', 'bg-green-50');
            item.classList.add('border-gray-200');
            rankBadge.classList.remove('bg-green-500', 'text-white');
            rankBadge.classList.add('bg-gray-200');
        }
    });
}

// Save third place order to state
function saveThirdPlaceOrder() {
    const items = document.querySelectorAll('#ranking-list .draggable');
    const rankings = [];
    items.forEach(item => {
        const teamId = parseInt(item.dataset.teamId);
        if (!isNaN(teamId)) {
            rankings.push(teamId);
        }
    });
    saveThirdPlaceRanking(rankings);
    updateRankBadges();
}

// Apply third place ranking from state
function applyThirdPlaceRanking(rankings) {
    // This will be called when loading state from URL
    // The recalculateAllStandings function handles this
}

// Navigate to knockout page with state preserved in URL
function goToKnockout() {
    const encoded = encodeState(window.bracketState);
    if (encoded) {
        window.location.href = `/bracket?s=${encoded}`;
    } else {
        window.location.href = '/bracket';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Debug: Log match data
    console.log('Match data loaded:', Object.keys(window.matchData).length, 'matches');
    console.log('Group teams loaded:', Object.keys(window.groupTeams));

    // Load state from URL (already done in app.js)
    setTimeout(() => {
        console.log('Predictions loaded:', Object.keys(window.bracketState.groupPredictions).length);
        recalculateAllStandings();
    }, 100);
});
</script>
{% endblock %}
