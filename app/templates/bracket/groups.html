{% extends "base.html" %}
{% from "components/team_flag.html" import flag %}

{% block title %}Group Stage - FIFA World Cup 2026{% endblock %}

{% block head %}
<style>
    html {
        scroll-behavior: smooth;
    }

    /* ══════════════════════════════════════════════════════════════════
       TYPOGRAPHY & COLOR TOKENS
    ══════════════════════════════════════════════════════════════════ */
    :root {
        --groups-bg: #F7F6F3;
        --groups-surface: #FFFFFF;
        --groups-border: rgba(0, 0, 0, 0.06);
        --groups-border-strong: rgba(0, 0, 0, 0.12);
        --groups-text: #1a1a1a;
        --groups-text-secondary: #6b6b6b;
        --groups-text-muted: #9a9a9a;
        --groups-accent: #2563eb;
        --groups-accent-light: rgba(37, 99, 235, 0.08);
        --groups-success: #16a34a;
        --groups-success-light: rgba(22, 163, 74, 0.08);
        --groups-warning: #ca8a04;
        --groups-warning-light: rgba(202, 138, 4, 0.08);
    }

    .groups-page {
        font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--groups-bg);
        min-height: 100vh;
    }

    /* ══════════════════════════════════════════════════════════════════
       STICKY NAVIGATION BAR
    ══════════════════════════════════════════════════════════════════ */
    .groups-nav {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(247, 246, 243, 0.92);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--groups-border);
        margin: 0 -1rem;
        padding: 0 1rem;
    }

    .groups-nav-inner {
        max-width: 72rem;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        padding: 0.875rem 0;
    }

    .groups-nav-pills {
        display: flex;
        gap: 0.25rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding: 0.25rem;
        margin: -0.25rem;
    }

    .groups-nav-pills::-webkit-scrollbar {
        display: none;
    }

    .group-pill {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 2.75rem;
        height: 2.75rem;
        font-size: 0.8125rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        color: var(--groups-text-secondary);
        background: transparent;
        border: 1px solid transparent;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .group-pill:hover {
        color: var(--groups-text);
        background: rgba(0, 0, 0, 0.04);
    }

    .group-pill.active {
        color: var(--groups-text);
        background: var(--groups-surface);
        border-color: var(--groups-border-strong);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .group-pill .status-dot {
        position: absolute;
        top: 0.375rem;
        right: 0.375rem;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: #d4d4d4;
    }

    .group-pill .status-dot.partial {
        background: var(--groups-warning);
    }

    .group-pill .status-dot.complete {
        background: var(--groups-success);
    }

    /* Nav Actions */
    .nav-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .nav-btn {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--groups-text-secondary);
        background: transparent;
        border: 1px solid var(--groups-border-strong);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }

    .nav-btn:hover {
        color: var(--groups-text);
        background: var(--groups-surface);
        border-color: var(--groups-border-strong);
    }

    .nav-btn.primary {
        color: white;
        background: var(--groups-accent);
        border-color: var(--groups-accent);
    }

    .nav-btn.primary:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
    }

    .nav-btn svg {
        width: 14px;
        height: 14px;
    }

    /* Progress indicator */
    .nav-progress {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--groups-text-muted);
        padding-right: 0.75rem;
        border-right: 1px solid var(--groups-border);
        margin-right: 0.25rem;
    }

    .nav-progress strong {
        color: var(--groups-text);
        font-weight: 600;
    }

    /* ══════════════════════════════════════════════════════════════════
       PAGE HEADER
    ══════════════════════════════════════════════════════════════════ */
    .groups-header {
        max-width: 72rem;
        margin: 0 auto;
        padding: 2.5rem 0 1.5rem;
    }

    .groups-header h1 {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.875rem;
        font-weight: 500;
        color: var(--groups-text);
        letter-spacing: -0.01em;
        margin-bottom: 0.375rem;
    }

    .groups-header p {
        font-size: 0.875rem;
        color: var(--groups-text-secondary);
        line-height: 1.5;
    }

    /* ══════════════════════════════════════════════════════════════════
       GROUP SECTION
    ══════════════════════════════════════════════════════════════════ */
    .group-section {
        scroll-margin-top: 5rem;
        max-width: 72rem;
        margin: 0 auto;
        padding-bottom: 3rem;
    }

    .group-section:last-of-type {
        padding-bottom: 1rem;
    }

    /* Group Header */
    .group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 0;
        margin-bottom: 0.75rem;
        border-bottom: 1px solid var(--groups-border);
    }

    .group-header-left {
        display: flex;
        align-items: baseline;
        gap: 0.75rem;
    }

    .group-header h2 {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.375rem;
        font-weight: 500;
        color: var(--groups-text);
        letter-spacing: -0.01em;
    }

    .group-header .predictions-count {
        font-size: 0.75rem;
        color: var(--groups-text-muted);
        font-weight: 500;
    }

    /* Randomize Button - More Prominent */
    .randomize-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--groups-accent);
        background: var(--groups-accent-light);
        border: 1px solid rgba(37, 99, 235, 0.2);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .randomize-btn:hover {
        background: rgba(37, 99, 235, 0.12);
        border-color: rgba(37, 99, 235, 0.3);
    }

    .randomize-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Two Column Layout */
    .group-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        align-items: start;
    }

    @media (max-width: 900px) {
        .group-content {
            grid-template-columns: 1fr;
        }
    }

    /* ══════════════════════════════════════════════════════════════════
       STANDINGS CARD
    ══════════════════════════════════════════════════════════════════ */
    .standings-card {
        background: var(--groups-surface);
        border: 1px solid var(--groups-border);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .standings-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--groups-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .standings-card-header h3 {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--groups-text-muted);
    }

    .standings-table {
        width: 100%;
        font-size: 0.8125rem;
    }

    .standings-table th {
        font-weight: 500;
        color: var(--groups-text-muted);
        text-align: center;
        padding: 0.625rem 0.5rem;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        background: rgba(0, 0, 0, 0.02);
        border-bottom: 1px solid var(--groups-border);
    }

    .standings-table th:first-child,
    .standings-table th:nth-child(2) {
        text-align: left;
        padding-left: 1.25rem;
    }

    .standings-table th:last-child {
        padding-right: 1.25rem;
    }

    .standings-table td {
        padding: 0.75rem 0.5rem;
        text-align: center;
        color: var(--groups-text-secondary);
        border-bottom: 1px solid var(--groups-border);
    }

    .standings-table td:first-child,
    .standings-table td:nth-child(2) {
        text-align: left;
        padding-left: 1.25rem;
    }

    .standings-table td:last-child {
        padding-right: 1.25rem;
    }

    .standings-table tbody tr:last-child td {
        border-bottom: none;
    }

    .standings-table tr.qualifies {
        background: var(--groups-success-light);
    }

    .standings-table tr.third-place {
        background: var(--groups-warning-light);
    }

    .standings-table .rank-cell {
        font-weight: 600;
        color: var(--groups-text-muted);
        width: 2rem;
    }

    .standings-table .team-cell {
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .standings-table .team-cell span {
        font-weight: 500;
        color: var(--groups-text);
    }

    .standings-table .pts-cell {
        font-weight: 700;
        color: var(--groups-text);
    }

    /* Legend */
    .standings-legend {
        display: flex;
        gap: 1.25rem;
        padding: 0.875rem 1.25rem;
        border-top: 1px solid var(--groups-border);
        font-size: 0.6875rem;
        color: var(--groups-text-muted);
    }

    .standings-legend span {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .standings-legend .dot {
        width: 8px;
        height: 8px;
        border-radius: 2px;
    }

    .standings-legend .dot.qualify {
        background: var(--groups-success);
    }

    .standings-legend .dot.third {
        background: var(--groups-warning);
    }

    /* ══════════════════════════════════════════════════════════════════
       MATCHES CARD
    ══════════════════════════════════════════════════════════════════ */
    .matches-card {
        background: var(--groups-surface);
        border: 1px solid var(--groups-border);
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .matches-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--groups-border);
    }

    .matches-card-header h3 {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--groups-text-muted);
    }

    .matches-list {
        padding: 0.5rem 0;
    }

    /* Match Row */
    .match-row {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--groups-border);
        transition: background 0.15s ease;
    }

    .match-row:last-child {
        border-bottom: none;
    }

    .match-row:hover {
        background: rgba(0, 0, 0, 0.01);
    }

    /* Team Display */
    .match-team {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--groups-text);
    }

    .match-team.home {
        justify-content: flex-end;
        text-align: right;
    }

    .match-team.away {
        justify-content: flex-start;
    }

    .match-team .team-name {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Prediction Controls */
    .match-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .score-input {
        width: 2rem;
        height: 2rem;
        text-align: center;
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--groups-text);
        background: var(--groups-bg);
        border: 1px solid var(--groups-border-strong);
        border-radius: 0.375rem;
        outline: none;
        transition: all 0.15s ease;
    }

    .score-input:focus {
        border-color: var(--groups-accent);
        box-shadow: 0 0 0 2px var(--groups-accent-light);
    }

    .score-input::placeholder {
        color: #ccc;
    }

    .outcome-btns {
        display: flex;
        gap: 0.125rem;
        margin: 0 0.25rem;
    }

    .outcome-btn {
        width: 1.75rem;
        height: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6875rem;
        font-weight: 600;
        color: var(--groups-text-muted);
        background: var(--groups-bg);
        border: 1px solid var(--groups-border-strong);
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .outcome-btn:hover {
        background: rgba(0, 0, 0, 0.06);
        color: var(--groups-text);
    }

    .outcome-btn.selected {
        color: white;
        border-color: transparent;
    }

    .outcome-btn.selected[data-outcome="home_win"] {
        background: #2563eb;
    }

    .outcome-btn.selected[data-outcome="draw"] {
        background: #6b7280;
    }

    .outcome-btn.selected[data-outcome="away_win"] {
        background: #059669;
    }

    /* Match Metadata */
    .match-meta {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        padding-top: 0.5rem;
        font-size: 0.6875rem;
        color: var(--groups-text-muted);
    }

    .match-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .match-meta svg {
        width: 12px;
        height: 12px;
        opacity: 0.6;
    }

    /* ══════════════════════════════════════════════════════════════════
       THIRD PLACE SECTION
    ══════════════════════════════════════════════════════════════════ */
    .third-place-section {
        max-width: 72rem;
        margin: 0 auto;
        padding: 3rem 0;
        border-top: 1px solid var(--groups-border-strong);
    }

    .third-place-header {
        margin-bottom: 1.5rem;
    }

    .third-place-header h2 {
        font-family: 'Cormorant Garamond', Georgia, serif;
        font-size: 1.375rem;
        font-weight: 500;
        color: var(--groups-text);
        margin-bottom: 0.25rem;
    }

    .third-place-header p {
        font-size: 0.8125rem;
        color: var(--groups-text-secondary);
    }

    .third-place-list {
        max-width: 32rem;
    }

    .third-place-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1rem;
        background: var(--groups-surface);
        border: 1px solid var(--groups-border);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: grab;
        transition: all 0.15s ease;
    }

    .third-place-item:active {
        cursor: grabbing;
    }

    .third-place-item.qualifies {
        border-color: rgba(22, 163, 74, 0.3);
        background: var(--groups-success-light);
    }

    .third-place-item.dragging {
        opacity: 0.5;
        transform: scale(1.02);
    }

    .third-place-item.drag-over {
        border-color: var(--groups-accent);
        border-style: dashed;
    }

    .third-place-item-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .third-place-rank {
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6875rem;
        font-weight: 700;
        border-radius: 0.25rem;
        background: #e5e5e5;
        color: #666;
    }

    .third-place-item.qualifies .third-place-rank {
        background: var(--groups-success);
        color: white;
    }

    .third-place-team {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--groups-text);
    }

    .third-place-group {
        font-size: 0.6875rem;
        color: var(--groups-text-muted);
    }

    .third-place-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.6875rem;
    }

    .third-place-stats > div {
        text-align: center;
    }

    .third-place-stats .value {
        font-weight: 700;
        color: var(--groups-text);
    }

    .third-place-stats .label {
        color: var(--groups-text-muted);
    }

    /* Continue Button */
    .continue-section {
        max-width: 72rem;
        margin: 0 auto;
        padding: 2rem 0 3rem;
    }

    .continue-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        font-size: 0.9375rem;
        font-weight: 600;
        color: white;
        background: var(--groups-accent);
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .continue-btn:hover {
        background: #1d4ed8;
    }

    .continue-btn svg {
        width: 18px;
        height: 18px;
    }

    /* ══════════════════════════════════════════════════════════════════
       MOBILE RESPONSIVE
    ══════════════════════════════════════════════════════════════════ */
    @media (max-width: 640px) {
        .groups-nav-inner {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .nav-actions {
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .nav-progress {
            border-right: none;
            padding-right: 0;
            margin-right: 0;
        }

        .group-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .match-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            padding: 1rem;
        }

        .match-team {
            justify-content: center !important;
            text-align: center !important;
        }

        .match-controls {
            justify-content: center;
            order: 2;
            padding: 0.5rem 0;
        }

        .match-team.home { order: 0; }
        .match-team.away { order: 1; }
        .match-meta { order: 3; }
    }

    /* ══════════════════════════════════════════════════════════════════
       RESULT STATES (for actual results)
    ══════════════════════════════════════════════════════════════════ */
    .match-row.correct-exact {
        background: rgba(22, 163, 74, 0.06);
        border-left: 3px solid var(--groups-success);
        margin-left: -3px;
        padding-left: calc(1.25rem + 3px);
    }

    .match-row.correct-outcome {
        background: rgba(202, 138, 4, 0.06);
        border-left: 3px solid var(--groups-warning);
        margin-left: -3px;
        padding-left: calc(1.25rem + 3px);
    }

    .match-row.incorrect {
        background: rgba(239, 68, 68, 0.04);
        border-left: 3px solid #ef4444;
        margin-left: -3px;
        padding-left: calc(1.25rem + 3px);
    }

    .actual-result-bar {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding-top: 0.5rem;
        margin-top: 0.25rem;
        border-top: 1px dashed var(--groups-border);
        font-size: 0.6875rem;
    }

    .actual-result-bar .actual-score {
        color: var(--groups-text-secondary);
    }

    .points-badge-small {
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
    }

    .points-badge-small.points-3 {
        background: var(--groups-success-light);
        color: var(--groups-success);
    }

    .points-badge-small.points-1, .points-badge-small.points-2 {
        background: var(--groups-warning-light);
        color: var(--groups-warning);
    }

    .points-badge-small.points-0 {
        background: rgba(239, 68, 68, 0.08);
        color: #dc2626;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--groups-surface);
        border: 1px solid var(--groups-border);
        border-radius: 0.75rem;
        max-width: 32rem;
        margin: 0 auto;
    }

    .empty-state p {
        color: var(--groups-text-secondary);
        font-size: 0.9375rem;
    }

    .empty-state p:last-child {
        font-size: 0.8125rem;
        color: var(--groups-text-muted);
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="groups-page">
    <!-- Page Header -->
    <div class="groups-header">
        <h1>Group Stage</h1>
        <p>Predict match outcomes for all 12 groups. Top 2 teams from each group qualify automatically.</p>
    </div>

    {% if not groups %}
        <div class="empty-state">
            <p>No groups have been set up yet.</p>
            <p>Check back when the tournament draw is complete.</p>
        </div>
    {% else %}
        <!-- Sticky Navigation Bar -->
        <div class="groups-nav">
            <div class="groups-nav-inner">
                <!-- Group Pills -->
                <div class="groups-nav-pills">
                    {% for group_letter in groups.keys() %}
                        <a class="group-pill {% if loop.first %}active{% endif %}"
                           href="#group-{{ group_letter }}"
                           data-group-nav="{{ group_letter }}"
                           onclick="setActiveGroup('{{ group_letter }}')">
                            {{ group_letter }}
                            <span class="status-dot" data-progress-dot="{{ group_letter }}"></span>
                        </a>
                    {% endfor %}
                </div>

                <!-- Actions -->
                <div class="nav-actions">
                    <div class="nav-progress">
                        <span>Progress:</span>
                        <strong id="totalProgress">0/72</strong>
                    </div>

                    <button onclick="autoSelectAllGroups()" class="nav-btn primary">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Auto-Fill All
                    </button>

                    <button onclick="randomizeActiveGroup()" class="nav-btn" id="randomizeActiveBtn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Shuffle Group
                    </button>

                    <button onclick="resetAllPredictions()" class="nav-btn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Reset
                    </button>

                    <button onclick="copyShareableLink()" class="nav-btn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                        Share
                    </button>
                </div>
            </div>
        </div>

        <!-- Group Sections -->
        {% for group_letter, group_data in groups.items() %}
            <section id="group-{{ group_letter }}"
                     class="group-section"
                     data-group-section="{{ group_letter }}"
                     data-group="{{ group_letter }}">

                <!-- Group Header with Randomize Button -->
                <div class="group-header">
                    <div class="group-header-left">
                        <h2>Group {{ group_letter }}</h2>
                        <span class="predictions-count" data-count-group="{{ group_letter }}">0/{{ group_data.matches|length }}</span>
                    </div>

                    <button onclick="autoSelectGroup('{{ group_letter }}')" class="randomize-btn">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Randomize This Group
                    </button>
                </div>

                <!-- Two Column Layout -->
                <div class="group-content">
                    <!-- Standings Column -->
                    <div class="standings-card">
                        <div class="standings-card-header">
                            <h3>Standings</h3>
                        </div>

                        <table class="standings-table" id="standings-{{ group_letter }}">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Team</th>
                                    <th>P</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>GD</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in group_data.teams %}
                                    <tr data-team-id="{{ team.id }}" class="{% if loop.index <= 2 %}qualifies{% elif loop.index == 3 %}third-place{% endif %}">
                                        <td class="rank-cell">{{ loop.index }}</td>
                                        <td>
                                            <div class="team-cell">
                                                {{ flag(team.country_code, 20) }}
                                                <span>{{ team.country_code }}</span>
                                            </div>
                                        </td>
                                        <td class="played-cell">0</td>
                                        <td class="gf-cell">0</td>
                                        <td class="ga-cell">0</td>
                                        <td class="gd-cell">0</td>
                                        <td class="pts-cell">0</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="standings-legend">
                            <span><span class="dot qualify"></span> Advances automatically</span>
                            <span><span class="dot third"></span> Third place playoff</span>
                        </div>
                    </div>

                    <!-- Matches Column -->
                    <div class="matches-card">
                        <div class="matches-card-header">
                            <h3>Matches</h3>
                        </div>

                        <div class="matches-list">
                            {% for match in group_data.matches %}
                                <div class="match-row"
                                     data-match-number="{{ match.match_number }}"
                                     data-home-team-id="{{ match.home_team_id }}"
                                     data-away-team-id="{{ match.away_team_id }}"
                                     data-group="{{ group_letter }}">

                                    <!-- Home Team -->
                                    <div class="match-team home">
                                        <span class="team-name">{{ match.home_team.name }}</span>
                                        {{ flag(match.home_team.country_code, 20) }}
                                    </div>

                                    <!-- Prediction Controls -->
                                    <div class="match-controls">
                                        <input type="number" min="0" max="20" class="score-input home-score" placeholder="-" onchange="handleScoreChange({{ match.match_number }})">

                                        <div class="outcome-btns">
                                            <button type="button" class="outcome-btn prediction-btn" data-outcome="home_win" onclick="handlePrediction({{ match.match_number }}, 'home_win')">H</button>
                                            <button type="button" class="outcome-btn prediction-btn" data-outcome="draw" onclick="handlePrediction({{ match.match_number }}, 'draw')">D</button>
                                            <button type="button" class="outcome-btn prediction-btn" data-outcome="away_win" onclick="handlePrediction({{ match.match_number }}, 'away_win')">A</button>
                                        </div>

                                        <input type="number" min="0" max="20" class="score-input away-score" placeholder="-" onchange="handleScoreChange({{ match.match_number }})">
                                    </div>

                                    <!-- Away Team -->
                                    <div class="match-team away">
                                        {{ flag(match.away_team.country_code, 20) }}
                                        <span class="team-name">{{ match.away_team.name }}</span>
                                    </div>

                                    <!-- Match Metadata -->
                                    <div class="match-meta">
                                        <span>
                                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            {{ match.scheduled_datetime.strftime('%b %d, %H:%M') }}
                                        </span>
                                        {% if match.stadium %}
                                            <span>
                                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                                {{ match.stadium.name }}, {{ match.stadium.city }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>
        {% endfor %}

        <!-- Third Place Ranking Section -->
        <div class="third-place-section">
            <div class="third-place-header">
                <h2>Third Place Ranking</h2>
                <p>Drag to reorder. Top 8 third-place teams advance to the Round of 32.</p>
            </div>

            <div class="third-place-list" id="ranking-list">
                <p style="color: var(--groups-text-muted); text-align: center; padding: 2rem;">
                    Complete group predictions to see third-place teams
                </p>
            </div>
        </div>

        <!-- Continue Section -->
        <div class="continue-section">
            <button onclick="goToKnockout()" class="continue-btn">
                Continue to Knockout Stage
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
            </button>
        </div>
    {% endif %}
</div>

<script>
// Initialize match data from server
window.matchData = {{ match_data_json|safe }};

// Group teams data for standings calculation
window.groupTeams = {
    {% for group_letter, group_data in groups.items() %}
    '{{ group_letter }}': [
        {% for team in group_data.teams %}
        { id: {{ team.id }}, name: '{{ team.name }}', country_code: '{{ team.country_code }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

let currentActiveGroup = null;

function updateActiveNav(groupLetter) {
    document.querySelectorAll('.group-pill').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.groupNav === groupLetter);
    });
    // Update the shuffle button text to show current group
    const shuffleBtn = document.getElementById('randomizeActiveBtn');
    if (shuffleBtn) {
        shuffleBtn.innerHTML = `
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Shuffle Group ${groupLetter}
        `;
    }
}

function setActiveGroup(groupLetter) {
    currentActiveGroup = groupLetter;
    updateActiveNav(groupLetter);
}

function initGroupObserver() {
    const sections = document.querySelectorAll('[data-group-section]');
    if (!sections.length) return;

    const observer = new IntersectionObserver(entries => {
        const visible = entries.filter(entry => entry.isIntersecting);
        if (!visible.length) return;

        visible.sort((a, b) => b.intersectionRatio - a.intersectionRatio);
        const groupLetter = visible[0].target.dataset.groupSection;
        if (groupLetter && groupLetter !== currentActiveGroup) {
            setActiveGroup(groupLetter);
        }
    }, { threshold: [0.2, 0.4, 0.6], rootMargin: '-20% 0px -60% 0px' });

    sections.forEach(section => observer.observe(section));

    const firstGroup = sections[0].dataset.groupSection;
    if (firstGroup) {
        setActiveGroup(firstGroup);
    }
}

// Handle prediction button click
function handlePrediction(matchNumber, outcome) {
    const matchRow = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchRow) return;

    const homeScoreInput = matchRow.querySelector('.home-score');
    const awayScoreInput = matchRow.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    selectPrediction(matchNumber, outcome);
    savePredictionLocal(matchNumber, outcome, homeScore, awayScore, null, true);
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
}

// Handle score input change
function handleScoreChange(matchNumber) {
    const matchRow = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchRow) return;

    const homeScoreInput = matchRow.querySelector('.home-score');
    const awayScoreInput = matchRow.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    let outcome = null;
    if (homeScore !== null && awayScore !== null) {
        if (homeScore > awayScore) outcome = 'home_win';
        else if (awayScore > homeScore) outcome = 'away_win';
        else outcome = 'draw';
        selectPrediction(matchNumber, outcome);
    }

    const currentPred = window.bracketState.groupPredictions[matchNumber];
    const finalOutcome = outcome || (currentPred ? currentPred.outcome : null);

    if (finalOutcome) {
        savePredictionLocal(matchNumber, finalOutcome, homeScore, awayScore, null, true);
        recalculateAllStandings();
        updateAllProgressIndicators();
        applyActualResultsToGroups();
    }
}

// Update progress indicators
function updateAllProgressIndicators() {
    const groupLetters = Object.keys(window.groupTeams);
    let totalPredicted = 0;

    groupLetters.forEach(group => {
        const section = document.querySelector(`[data-group-section="${group}"]`);
        const navPill = document.querySelector(`[data-group-nav="${group}"]`);
        if (!section) return;

        const matchRows = section.querySelectorAll('[data-match-number]');
        let predictedCount = 0;

        matchRows.forEach(row => {
            const matchNumber = row.dataset.matchNumber;
            if (window.bracketState.groupPredictions[matchNumber]) {
                predictedCount++;
                totalPredicted++;
            }
        });

        // Update count display
        const countEl = section.querySelector(`[data-count-group="${group}"]`);
        if (countEl) {
            countEl.textContent = `${predictedCount}/${matchRows.length}`;
        }

        // Update progress dot
        const progressDot = navPill?.querySelector('.status-dot');
        if (progressDot) {
            progressDot.classList.remove('partial', 'complete');
            if (predictedCount === matchRows.length) {
                progressDot.classList.add('complete');
            } else if (predictedCount > 0) {
                progressDot.classList.add('partial');
            }
        }
    });

    // Update total progress
    const totalEl = document.getElementById('totalProgress');
    if (totalEl) {
        totalEl.textContent = `${totalPredicted}/72`;
    }
}

function calculateGroupMatchResult(prediction, matchInfo) {
    if (!matchInfo) return null;
    if (matchInfo.actualHomeScore == null || matchInfo.actualAwayScore == null) return null;

    const actualHomeScore = matchInfo.actualHomeScore;
    const actualAwayScore = matchInfo.actualAwayScore;

    let actualOutcome;
    if (actualHomeScore > actualAwayScore) actualOutcome = 'home_win';
    else if (actualAwayScore > actualHomeScore) actualOutcome = 'away_win';
    else actualOutcome = 'draw';

    let points = 0;
    let className = 'incorrect';
    let pointsText = 'No prediction';

    if (prediction) {
        const predHomeScore = prediction.homeScore ?? null;
        const predAwayScore = prediction.awayScore ?? null;

        if (predHomeScore !== null && predAwayScore !== null &&
            predHomeScore === actualHomeScore && predAwayScore === actualAwayScore) {
            points = 3;
            className = 'correct-exact';
        } else if (prediction.outcome === actualOutcome) {
            points = 1;
            className = 'correct-outcome';
        }

        pointsText = `+${points} pts`;
    }

    const pointsClass = points >= 3 ? 'points-3' : (points === 1 ? 'points-1' : 'points-0');
    return { className, pointsText, pointsClass, actualHomeScore, actualAwayScore };
}

function applyActualResultsToGroups() {
    document.querySelectorAll('.match-row .actual-result-bar').forEach(el => el.remove());

    document.querySelectorAll('.match-row[data-match-number]').forEach(card => {
        card.classList.remove('correct-exact', 'correct-outcome', 'incorrect');

        const matchNumber = card.dataset.matchNumber;
        const matchInfo = window.matchData?.[matchNumber];
        const prediction = window.bracketState.groupPredictions?.[matchNumber];
        const result = calculateGroupMatchResult(prediction, matchInfo);
        if (!result) return;

        card.classList.add(result.className);

        const bar = document.createElement('div');
        bar.className = 'actual-result-bar';
        bar.innerHTML = `
            <span class="actual-score">Actual: ${result.actualHomeScore} - ${result.actualAwayScore}</span>
            <span class="points-badge-small ${result.pointsClass}">${result.pointsText}</span>
        `;

        card.appendChild(bar);
    });
}

function generateRandomScoreForOutcome(outcome) {
    let homeScore;
    let awayScore;

    if (outcome === 'home_win') {
        homeScore = Math.floor(Math.random() * 4) + 1;
        awayScore = Math.floor(Math.random() * homeScore);
    } else if (outcome === 'away_win') {
        awayScore = Math.floor(Math.random() * 4) + 1;
        homeScore = Math.floor(Math.random() * awayScore);
    } else {
        homeScore = awayScore = Math.floor(Math.random() * 4);
    }

    return { homeScore, awayScore };
}

function randomizeActiveGroup() {
    const group = currentActiveGroup || Object.keys(window.groupTeams)[0];
    if (!group) return;
    autoSelectGroup(group);
}

// Auto-select all groups
async function autoSelectAllGroups() {
    const matchRows = document.querySelectorAll('[data-match-number]');
    let selectedCount = 0;

    matchRows.forEach(row => {
        const matchNumber = parseInt(row.dataset.matchNumber);
        if (matchNumber <= 72) {
            const outcomes = ['home_win', 'draw', 'away_win'];
            const randomOutcome = outcomes[Math.floor(Math.random() * 3)];
            const { homeScore, awayScore } = generateRandomScoreForOutcome(randomOutcome);

            selectPrediction(matchNumber, randomOutcome);
            row.querySelector('.home-score').value = homeScore;
            row.querySelector('.away-score').value = awayScore;
            savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
            selectedCount++;
        }
    });

    updateURLState();
    await new Promise(resolve => setTimeout(resolve, 50));
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
    showToast(`Auto-filled ${selectedCount} matches`, 'success');
}

// Auto-select single group
async function autoSelectGroup(groupLetter) {
    const section = document.querySelector(`[data-group-section="${groupLetter}"]`);
    if (!section) return;

    const matchRows = section.querySelectorAll('[data-match-number]');
    let selectedCount = 0;

    matchRows.forEach(row => {
        const matchNumber = parseInt(row.dataset.matchNumber);
        const outcomes = ['home_win', 'draw', 'away_win'];
        const randomOutcome = outcomes[Math.floor(Math.random() * 3)];
        const { homeScore, awayScore } = generateRandomScoreForOutcome(randomOutcome);

        selectPrediction(matchNumber, randomOutcome);
        row.querySelector('.home-score').value = homeScore;
        row.querySelector('.away-score').value = awayScore;
        savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
        selectedCount++;
    });

    updateURLState();
    await new Promise(resolve => setTimeout(resolve, 50));
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
    showToast(`Group ${groupLetter}: ${selectedCount} matches randomized`, 'success');
}

// Recalculate all group standings
function recalculateAllStandings() {
    const groupLetters = Object.keys(window.groupTeams);
    const thirdPlaceTeams = [];

    groupLetters.forEach(group => {
        const standings = calculateGroupStandings(group, window.groupTeams[group], window.bracketState.groupPredictions);
        updateStandingsUI(group, standings);

        if (standings.length >= 3) {
            thirdPlaceTeams.push({
                ...standings[2],
                group: group
            });
        }
    });

    updateThirdPlaceRanking(thirdPlaceTeams);
}

// Update standings table UI
function updateStandingsUI(groupLetter, standings) {
    const table = document.getElementById(`standings-${groupLetter}`);
    if (!table) return;

    const tbody = table.querySelector('tbody');

    standings.forEach((team, index) => {
        const row = tbody.querySelector(`tr[data-team-id="${team.team_id}"]`);
        if (row) {
            row.querySelector('.rank-cell').textContent = index + 1;
            row.querySelector('.played-cell').textContent = team.played;
            row.querySelector('.gf-cell').textContent = team.goals_for;
            row.querySelector('.ga-cell').textContent = team.goals_against;
            row.querySelector('.gd-cell').textContent = team.goal_diff;
            row.querySelector('.pts-cell').textContent = team.points;

            row.className = '';
            row.setAttribute('data-team-id', team.team_id);
            if (index < 2) {
                row.classList.add('qualifies');
            } else if (index === 2) {
                row.classList.add('third-place');
            }

            tbody.appendChild(row);
        }
    });
}

// Update third place ranking UI
function updateThirdPlaceRanking(thirdPlaceTeams) {
    const rankingList = document.getElementById('ranking-list');
    if (!rankingList) return;

    thirdPlaceTeams.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.goal_diff !== a.goal_diff) return b.goal_diff - a.goal_diff;
        return b.goals_for - a.goals_for;
    });

    if (window.bracketState.thirdPlaceRanking && window.bracketState.thirdPlaceRanking.length > 0) {
        const rankedTeams = [];
        const unrankedTeams = [...thirdPlaceTeams];

        window.bracketState.thirdPlaceRanking.forEach(teamId => {
            const idx = unrankedTeams.findIndex(t => t.team_id === teamId);
            if (idx !== -1) {
                rankedTeams.push(unrankedTeams.splice(idx, 1)[0]);
            }
        });

        thirdPlaceTeams.length = 0;
        thirdPlaceTeams.push(...rankedTeams, ...unrankedTeams);
    }

    if (thirdPlaceTeams.length === 0 || thirdPlaceTeams.every(t => t.played === 0)) {
        rankingList.innerHTML = '<p style="color: var(--groups-text-muted); text-align: center; padding: 2rem;">Complete group predictions to see third-place teams</p>';
        return;
    }

    rankingList.innerHTML = thirdPlaceTeams.map((team, index) => `
        <div class="third-place-item ${index < 8 ? 'qualifies' : ''}" data-team-id="${team.team_id}" draggable="true">
            <div class="third-place-item-left">
                <span class="third-place-rank">${index + 1}</span>
                <div>
                    <div class="third-place-team">${team.team_name}</div>
                    <div class="third-place-group">Group ${team.group}</div>
                </div>
            </div>
            <div class="third-place-stats">
                <div>
                    <div class="value">${team.points}</div>
                    <div class="label">Pts</div>
                </div>
                <div>
                    <div class="value">${team.goal_diff >= 0 ? '+' : ''}${team.goal_diff}</div>
                    <div class="label">GD</div>
                </div>
                <div>
                    <div class="value">${team.goals_for}</div>
                    <div class="label">GF</div>
                </div>
            </div>
        </div>
    `).join('');

    initDragAndDrop();
}

// Initialize drag and drop
function initDragAndDrop() {
    const list = document.getElementById('ranking-list');
    if (!list) return;

    let draggedItem = null;

    list.querySelectorAll('.third-place-item').forEach(item => {
        item.addEventListener('dragstart', function() {
            draggedItem = this;
            this.classList.add('dragging');
        });

        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            draggedItem = null;
            saveThirdPlaceOrder();
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        item.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedItem !== this) {
                const allItems = [...list.querySelectorAll('.third-place-item')];
                const draggedIdx = allItems.indexOf(draggedItem);
                const targetIdx = allItems.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }

                updateRankBadges();
            }
        });
    });
}

// Update rank badges after reordering
function updateRankBadges() {
    const items = document.querySelectorAll('#ranking-list .third-place-item');
    items.forEach((item, index) => {
        const rankBadge = item.querySelector('.third-place-rank');
        rankBadge.textContent = index + 1;

        if (index < 8) {
            item.classList.add('qualifies');
        } else {
            item.classList.remove('qualifies');
        }
    });
}

// Save third place order
function saveThirdPlaceOrder() {
    const items = document.querySelectorAll('#ranking-list .third-place-item');
    const rankings = [];
    items.forEach(item => {
        const teamId = parseInt(item.dataset.teamId);
        if (!isNaN(teamId)) {
            rankings.push(teamId);
        }
    });
    saveThirdPlaceRanking(rankings);
    updateRankBadges();
}

// Navigate to knockout page
function goToKnockout() {
    const encoded = encodeState(window.bracketState);
    if (encoded) {
        window.location.href = `/bracket?s=${encoded}`;
    } else {
        window.location.href = '/bracket';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        recalculateAllStandings();
        updateAllProgressIndicators();
        applyActualResultsToGroups();
        initGroupObserver();
    }, 100);
});
</script>
{% endblock %}
