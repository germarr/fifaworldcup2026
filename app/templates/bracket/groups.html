{% extends "base.html" %}
{% from "components/team_flag.html" import flag %}

{% block title %}Group Stage - FIFA World Cup 2026{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Group Stage Predictions</h1>

    <!-- Instructions Banner -->
    <div class="bg-gradient-to-r from-slate-200 to-slate-300 text-slate-900 rounded-lg p-6 mb-8 shadow-md border border-slate-400">
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Left Column: Basics -->
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">üìã</span> How to Fill Your Bracket
                </h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="font-semibold mb-1">üéØ Predict Match Outcomes:</p>
                        <ul class="ml-4 space-y-1 list-disc">
                            <li><strong>H</strong> = Home team wins</li>
                            <li><strong>D</strong> = Draw</li>
                            <li><strong>A</strong> = Away team wins</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">üìä Optional Scores:</p>
                        <p>Enter predicted scores (home-away). If you skip this, a random score matching your outcome will be generated automatically.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Scoring & Rules -->
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">üèÜ</span> Scoring & Rules
                </h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="font-semibold mb-1">üí∞ Points Earned:</p>
                        <ul class="ml-4 space-y-1 list-disc">
                            <li><strong>1 point</strong> - Correct outcome (H/D/A)</li>
                            <li><strong>3 points</strong> - Exact score (bonus!)</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">ü•â Third-Place Qualification:</p>
                        <p>Top 2 teams per group auto-qualify (24 teams). Best 8 of 12 third-place teams also advance to Round of 32 in your bracket.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Info Banner -->
        <div class="mt-4 pt-4 border-t border-slate-400 text-xs">
            <p class="mb-2">
                <strong>‚è∞ Deadline:</strong> Predictions lock once a match starts. Plan carefully!
            </p>
            <p>
                <strong>üìà Progress:</strong> Check the standings in real-time to see which teams are advancing based on your predictions.
            </p>
        </div>
    </div>

    {% if not groups %}
        <div class="card text-center py-12">
            <p class="text-gray-500 mb-4">No groups have been set up yet.</p>
            <p class="text-sm text-gray-400">Check back when the tournament draw is complete.</p>
        </div>
    {% else %}
        <!-- Auto-Select All Button & Reset Button -->
        <div class="mb-6 flex gap-3 justify-center">
            <button 
                id="autoSelectAllBtn"
                onclick="autoSelectAllGroups()" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2"
            >
                <span>‚ö° Auto-Select All Groups</span>
                <span id="autoSelectSpinner" class="hidden">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
            <button 
                id="resetAllBtn"
                onclick="resetAllPredictions()" 
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2"
            >
                <span>üîÑ Reset All</span>
                <span id="resetSpinner" class="hidden">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for group_letter, group_data in groups.items() %}
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-fifa-blue">Group {{ group_letter }}</h2>
                        <button 
                            onclick="autoSelectGroup('{{ group_letter }}')" 
                            class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded font-semibold transition"
                        >
                            ‚ö° Select
                        </button>
                    </div>

                    <!-- Standings -->
                    <div class="mb-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-1">#</th>
                                    <th class="text-left py-1">Team</th>
                                    <th class="text-center py-1">P</th>
                                    <th class="text-center py-1">GD</th>
                                    <th class="text-center py-1">Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in group_data.standings %}
                                    <tr class="border-b {{ 'bg-green-50' if loop.index <= 2 else ('bg-yellow-50' if loop.index == 3 else '') }}">
                                        <td class="py-1">{{ loop.index }}</td>
                                        <td class="py-1">
                                            {{ flag(team.country_code, 16) }}
                                            <span class="ml-1">{{ team.team_name }}</span>
                                        </td>
                                        <td class="text-center py-1">{{ team.played }}</td>
                                        <td class="text-center py-1">{{ team.goal_diff }}</td>
                                        <td class="text-center py-1 font-bold">{{ team.points }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="text-xs text-gray-500 mt-2">
                            <span class="inline-block w-3 h-3 bg-green-50 border mr-1"></span> Qualifies
                            <span class="inline-block w-3 h-3 bg-yellow-50 border ml-2 mr-1"></span> Third place
                        </div>
                    </div>

                    <!-- Matches -->
                    <div class="space-y-2">
                        {% for match in group_data.matches %}
                            <div class="match-card p-2 text-sm" data-match="{{ match.id }}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1">
                                        {{ flag(match.home_team.country_code, 16) }}
                                        <span class="truncate w-20">{{ match.home_team.name }}</span>
                                    </div>

                                    <div class="flex gap-1">
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 {{ 'selected' if match.prediction and match.prediction.predicted_outcome == 'home_win' }}"
                                            data-outcome="home_win"
                                            onclick="savePrediction({{ match.id }}, 'home_win', {{ match.home_team.id }})"
                                            {{ 'disabled' if match.locked }}
                                        >
                                            H
                                        </button>
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 {{ 'selected' if match.prediction and match.prediction.predicted_outcome == 'draw' }}"
                                            data-outcome="draw"
                                            onclick="savePrediction({{ match.id }}, 'draw', null)"
                                            {{ 'disabled' if match.locked }}
                                        >
                                            D
                                        </button>
                                        <button
                                            type="button"
                                            class="prediction-btn text-xs px-2 py-1 {{ 'selected' if match.prediction and match.prediction.predicted_outcome == 'away_win' }}"
                                            data-outcome="away_win"
                                            onclick="savePrediction({{ match.id }}, 'away_win', {{ match.away_team.id }})"
                                            {{ 'disabled' if match.locked }}
                                        >
                                            A
                                        </button>
                                    </div>

                                    <div class="flex items-center gap-1">
                                        <span class="truncate w-20 text-right">{{ match.away_team.name }}</span>
                                        {{ flag(match.away_team.country_code, 16) }}
                                    </div>
                                </div>

                                {% if not match.locked %}
                                    <div class="flex items-center justify-center gap-2 mt-2">
                                        <input
                                            type="number"
                                            min="0"
                                            max="20"
                                            class="w-12 text-center input-field text-xs py-1"
                                            placeholder="-"
                                            value="{{ match.prediction.predicted_home_score if match.prediction else '' }}"
                                            onchange="updateScore({{ match.id }}, 'home', this.value)"
                                        >
                                        <span class="text-gray-400">-</span>
                                        <input
                                            type="number"
                                            min="0"
                                            max="20"
                                            class="w-12 text-center input-field text-xs py-1"
                                            placeholder="-"
                                            value="{{ match.prediction.predicted_away_score if match.prediction else '' }}"
                                            onchange="updateScore({{ match.id }}, 'away', this.value)"
                                        >
                                    </div>
                                {% endif %}

                                {% if match.locked %}
                                    <div class="text-xs text-gray-400 text-center mt-1">Locked</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 text-center">
                        <span class="text-sm text-gray-500">
                            {{ group_data.predictions_count }}/{{ group_data.matches|length }} predicted
                        </span>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="mt-8 text-center">
            <a href="/bracket/third-place" class="btn-primary">
                Continue to Third Place Ranking &rarr;
            </a>
        </div>
    {% endif %}
</div>

<script>
const scores = {};

async function savePrediction(matchId, outcome, winnerId) {
    const data = {
        predicted_outcome: outcome,
        predicted_winner_team_id: winnerId,
        predicted_home_score: scores[matchId]?.home,
        predicted_away_score: scores[matchId]?.away
    };

    const success = await submitPrediction(matchId, outcome, data.predicted_home_score, data.predicted_away_score, window.bulkOperation);

    if (success) {
        // Update UI
        const buttons = document.querySelectorAll(`[data-match="${matchId}"] .prediction-btn`);
        buttons.forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.outcome === outcome) {
                btn.classList.add('selected');
            }
        });

        // Note: reload removed here to allow bulk operations
    }
    return success;
}

function updateScore(matchId, side, value) {
    if (!scores[matchId]) {
        scores[matchId] = { home: null, away: null };
    }
    scores[matchId][side] = value ? parseInt(value) : null;
}

// Auto-select all matches with random outcomes (H, D, or A)
async function autoSelectAllGroups() {
    // Show spinner
    const spinner = document.getElementById('autoSelectSpinner');
    const btn = document.getElementById('autoSelectAllBtn');
    spinner.classList.remove('hidden');
    btn.disabled = true;
    
    // Suppress individual toasts during bulk operation
    window.bulkOperation = true;
    
    const matchElements = document.querySelectorAll('[data-match]');
    let selectCount = 0;
    
    for (const element of matchElements) {
        const matchId = element.getAttribute('data-match');
        const buttons = element.querySelectorAll('.prediction-btn:not(:disabled)');
        
        if (buttons.length > 0) {
            // Check if already selected
            const alreadySelected = Array.from(buttons).some(btn => btn.classList.contains('selected'));
            
            if (!alreadySelected) {
                // Randomly select H, D, or A
                const randomOutcome = ['home_win', 'draw', 'away_win'][Math.floor(Math.random() * 3)];
                const selectedButton = element.querySelector(`[data-outcome="${randomOutcome}"]`);
                
                if (selectedButton && !selectedButton.disabled) {
                    await savePrediction(matchId, randomOutcome, randomOutcome === 'home_win' ? getWinnerId(element) : null);
                    selectCount++;
                    
                    // Small delay to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }
    }
    
    // Stop bulk operation
    window.bulkOperation = false;
    
    // Hide spinner and re-enable button
    spinner.classList.add('hidden');
    btn.disabled = false;
    
    // Show result toast only at the end
    if (selectCount > 0) {
        showToast(`Selected ${selectCount} matches! Reloading...`, 'success');
        setTimeout(() => location.reload(), 800);
    } else {
        showToast('All matches are already selected or locked!', 'info');
    }
}

// Auto-select all matches in a specific group
async function autoSelectGroup(groupLetter) {
    const groupCards = document.querySelectorAll('.card');
    let selectCount = 0;
    
    for (const card of groupCards) {
        const heading = card.querySelector('h2');
        if (heading && heading.textContent.includes(`Group ${groupLetter}`)) {
            const matchElements = card.querySelectorAll('[data-match]');
            
            for (const element of matchElements) {
                const matchId = element.getAttribute('data-match');
                const buttons = element.querySelectorAll('.prediction-btn:not(:disabled)');
                
                if (buttons.length > 0) {
                    // Check if already selected
                    const alreadySelected = Array.from(buttons).some(btn => btn.classList.contains('selected'));
                    
                    if (!alreadySelected) {
                        // Randomly select H, D, or A
                        const randomOutcome = ['home_win', 'draw', 'away_win'][Math.floor(Math.random() * 3)];
                        const selectedButton = element.querySelector(`[data-outcome="${randomOutcome}"]`);
                        
                        if (selectedButton && !selectedButton.disabled) {
                            await savePrediction(matchId, randomOutcome, randomOutcome === 'home_win' ? getWinnerId(element) : null);
                            selectCount++;
                            
                            // Small delay to avoid overwhelming the server
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
            }
            break; // Found the group, no need to continue
        }
    }
    
    // Reload once at the end to update standings
    if (selectCount > 0) {
        setTimeout(() => location.reload(), 800);
    } else {
        alert('All matches in this group are already selected or locked!');
    }
}

// Helper function to get winner ID
function getWinnerId(element) {
    const homeTeamButton = element.querySelector('[data-outcome="home_win"]');
    return homeTeamButton?.getAttribute('onclick')?.match(/savePrediction\([^,]+,\s*'[^']+',\s*(\d+)/)?.[1] || null;
}

// Reset all predictions by clearing from database via API
async function resetAllPredictions() {
    if (!confirm('Are you sure you want to reset ALL predictions? This cannot be undone.')) {
        return;
    }
    
    // Show spinner
    const spinner = document.getElementById('resetSpinner');
    const btn = document.getElementById('resetAllBtn');
    spinner.classList.remove('hidden');
    btn.disabled = true;
    
    const matchElements = document.querySelectorAll('[data-match]');
    let resetCount = 0;
    
    for (const element of matchElements) {
        const matchId = element.getAttribute('data-match');
        const buttons = element.querySelectorAll('.prediction-btn');
        
        // Check if any button is selected and not locked
        const hasSelection = Array.from(buttons).some(btn => btn.classList.contains('selected'));
        
        if (hasSelection && !buttons[0].disabled) {
            // Call API to delete the prediction
            try {
                const response = await fetch(`/api/predictions/match/${matchId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Remove selected class from all buttons
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    
                    // Clear score inputs if they exist
                    const scoreInputs = element.querySelectorAll('input[type="number"]');
                    scoreInputs.forEach(input => input.value = '');
                    
                    resetCount++;
                } else {
                    console.error('Failed to delete prediction:', response.statusText);
                }
            } catch (error) {
                console.error('Error resetting prediction:', error);
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
        }
    }
    
    // Hide spinner and re-enable button
    spinner.classList.add('hidden');
    btn.disabled = false;
    
    // Show result toast only at the end
    if (resetCount > 0) {
        showToast(`Reset ${resetCount} predictions!`, 'error');
        setTimeout(() => location.reload(), 800);
    } else {
        showToast('No predictions to reset!', 'info');
    }
}
</script>
{% endblock %}
