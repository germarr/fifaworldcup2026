{% extends "base.html" %}
{% from "components/team_flag.html" import flag %}

{% block title %}Group Stage - FIFA World Cup 2026{% endblock %}

{% block head %}
<style>
    html {
        scroll-behavior: smooth;
    }

    .group-section {
        scroll-margin-top: 6.5rem;
    }

    /* Group Navigation Pills */
    .group-nav {
        position: sticky;
        top: 0;
        z-index: 20;
        background: rgba(243, 244, 246, 0.96);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .group-nav-inner {
        padding: 0.75rem 0 1rem;
    }

    .group-pill {
        position: relative;
        padding: 0.625rem 1.25rem;
        font-weight: 600;
        font-size: 0.875rem;
        letter-spacing: 0.025em;
        color: var(--color-ink-muted);
        background: transparent;
        border: 1px solid transparent;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .group-pill:hover {
        color: var(--color-ink);
        background: var(--color-paper-dark);
    }

    .group-pill.active {
        color: var(--color-ink);
        background: white;
        border-color: rgba(0,0,0,0.08);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .group-pill .progress-dot {
        position: absolute;
        top: 0.375rem;
        right: 0.375rem;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #d1d5db;
    }

    .group-pill .progress-dot.partial {
        background: var(--color-trophy);
    }

    .group-pill .progress-dot.complete {
        background: #22c55e;
    }

    /* Group Panel */
    .group-panel {
        animation: slideIn 0.25s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Match Row */
    .match-card {
        position: relative;
        padding: 1.75rem 0 0.875rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .match-card:last-child {
        border-bottom: none;
    }

    .match-row {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 0.75rem;
    }

    .match-meta-top {
        position: absolute;
        top: 0.5rem;
        right: 0;
        font-size: 0.7rem;
        color: var(--color-ink-muted);
        text-align: right;
        white-space: nowrap;
    }

    .match-row .team {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .match-row .team.home {
        justify-content: flex-end;
        text-align: right;
    }

    .match-row .team.away {
        justify-content: flex-start;
    }

    /* Prediction Controls */
    .prediction-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .pred-btn {
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-ink-muted);
        background: var(--color-paper);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .pred-btn:hover {
        background: var(--color-paper-dark);
        border-color: rgba(0,0,0,0.15);
    }

    .pred-btn.selected {
        color: white;
        background: var(--color-fifa-blue);
        border-color: var(--color-fifa-blue);
    }

    .pred-btn.selected.home-win { background: #2563eb; border-color: #2563eb; }
    .pred-btn.selected.draw { background: #6b7280; border-color: #6b7280; }
    .pred-btn.selected.away-win { background: #059669; border-color: #059669; }

    /* Score Inputs */
    .score-input {
        width: 1.75rem;
        height: 1.75rem;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-ink);
        background: white;
        border: 1px solid rgba(0,0,0,0.12);
        border-radius: 0.25rem;
        outline: none;
        transition: border-color 0.15s;
    }

    .score-input:focus {
        border-color: var(--color-fifa-blue);
    }

    .score-input::placeholder {
        color: #d1d5db;
    }

    /* Standings Table */
    .standings-table {
        width: 100%;
        font-size: 0.8125rem;
    }

    .standings-table th {
        font-weight: 500;
        color: var(--color-ink-muted);
        text-align: center;
        padding: 0.5rem 0.25rem;
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .standings-table th:first-child,
    .standings-table th:nth-child(2) {
        text-align: left;
    }

    .standings-table td {
        padding: 0.625rem 0.25rem;
        text-align: center;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .standings-table td:first-child,
    .standings-table td:nth-child(2) {
        text-align: left;
    }

    .standings-table tr.qualifies {
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, transparent 100%);
    }

    .standings-table tr.third-place {
        background: linear-gradient(90deg, rgba(234, 179, 8, 0.08) 0%, transparent 100%);
    }

    .standings-table .rank {
        font-weight: 700;
        color: var(--color-ink-muted);
        width: 1.5rem;
    }

    .standings-table .team-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .standings-table .pts {
        font-weight: 700;
        color: var(--color-ink);
    }

    /* Mobile Optimizations */
    @media (max-width: 640px) {
        .match-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .match-row .team {
            justify-content: center !important;
            text-align: center !important;
        }

        .prediction-controls {
            justify-content: center;
            order: 2;
        }

        .match-row .team.home { order: 0; }
        .match-row .team.away { order: 1; }

        .match-card {
            padding-top: 2.25rem;
        }

        .match-meta-top {
            position: static;
            margin-bottom: 0.5rem;
            text-align: center;
            white-space: normal;
        }

        .group-nav-inner {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .group-nav-inner::-webkit-scrollbar {
            display: none;
        }
    }

    .group-divider {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 2rem 0 1.5rem;
        color: var(--color-ink-muted);
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.7rem;
    }

    .group-divider::before,
    .group-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: rgba(0,0,0,0.08);
    }

    /* Third Place Panel */
    .third-place-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 0.5rem;
        cursor: grab;
        transition: all 0.15s;
    }

    .third-place-item:active {
        cursor: grabbing;
    }

    .third-place-item.qualifies {
        border-color: rgba(34, 197, 94, 0.3);
        background: rgba(34, 197, 94, 0.04);
    }

    .third-place-item.dragging {
        opacity: 0.5;
        transform: scale(1.02);
    }

    .third-place-item.drag-over {
        border-color: var(--color-fifa-blue);
        border-style: dashed;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-semibold text-ink mb-2" style="font-family: 'Cormorant Garamond', serif;">Group Stage</h1>
        <p class="text-ink-muted text-sm">Predict match outcomes for all 12 groups. Top 2 teams qualify automatically.</p>
    </div>

    {% if not groups %}
        <div class="bg-white rounded-lg p-12 text-center border border-gray-100">
            <p class="text-ink-muted mb-2">No groups have been set up yet.</p>
            <p class="text-sm text-ink-muted opacity-60">Check back when the tournament draw is complete.</p>
        </div>
    {% else %}
        <!-- Quick Actions Bar -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6 pb-6 border-b border-gray-100">
            <div class="flex items-center gap-2 text-sm">
                <span class="text-ink-muted">Progress:</span>
                <span id="totalProgress" class="font-semibold text-ink">0/72</span>
                <span class="text-ink-muted">matches</span>
            </div>
            <div class="flex gap-2">
                <button onclick="autoSelectAllGroups()" class="px-4 py-2 text-sm font-medium text-white bg-fifa-blue hover:bg-blue-700 rounded-lg transition cursor-pointer">
                    Auto-Fill All
                </button>
                <button onclick="randomizeActiveGroup()" class="px-4 py-2 text-sm font-medium text-fifa-blue border border-blue-200 hover:bg-blue-50 rounded-lg transition cursor-pointer">
                    Randomize Group
                </button>
                <button onclick="resetAllPredictions()" class="px-4 py-2 text-sm font-medium text-ink-muted hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer">
                    Reset
                </button>
                <button onclick="copyShareableLink()" class="px-4 py-2 text-sm font-medium text-ink-muted hover:text-fifa-blue hover:bg-blue-50 rounded-lg transition cursor-pointer">
                    Share
                </button>
            </div>
        </div>

        <!-- Group Navigation -->
        <div class="group-nav mb-8">
            <div class="group-nav-inner flex gap-2">
                {% for group_letter in groups.keys() %}
                    <a
                        class="group-pill {% if loop.first %}active{% endif %}"
                        href="#group-{{ group_letter }}"
                        data-group-nav="{{ group_letter }}"
                        onclick="setActiveGroup('{{ group_letter }}')"
                    >
                        {{ group_letter }}
                        <span class="progress-dot" data-progress-dot="{{ group_letter }}"></span>
                    </a>
                {% endfor %}
            </div>
        </div>

        <!-- Group Panels -->
        {% for group_letter, group_data in groups.items() %}
            {% if not loop.first %}
                <div class="group-divider">
                    <span>Group {{ group_letter }}</span>
                </div>
            {% endif %}
            <section id="group-{{ group_letter }}" class="group-panel group-section" data-group-section="{{ group_letter }}" data-group="{{ group_letter }}">
                <div class="grid md:grid-cols-5 gap-8">
                    <!-- Standings Column -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-semibold text-ink">Group {{ group_letter }}</h2>
                                <button
                                    onclick="autoSelectGroup('{{ group_letter }}')"
                                    class="text-xs font-medium text-fifa-blue hover:underline cursor-pointer"
                                >
                                    Randomize
                                </button>
                            </div>

                            <table class="standings-table" id="standings-{{ group_letter }}">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Team</th>
                                        <th>P</th>
                                        <th>GF</th>
                                        <th>GA</th>
                                        <th>GD</th>
                                        <th>Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for team in group_data.teams %}
                                        <tr data-team-id="{{ team.id }}" class="{% if loop.index <= 2 %}qualifies{% elif loop.index == 3 %}third-place{% endif %}">
                                            <td class="rank rank-cell">{{ loop.index }}</td>
                                            <td>
                                                <div class="team-cell">
                                                    {{ flag(team.country_code, 20) }}
                                                    <span>{{ team.country_code }}</span>
                                                </div>
                                            </td>
                                            <td class="played-cell">0</td>
                                            <td class="gf-cell">0</td>
                                            <td class="ga-cell">0</td>
                                            <td class="gd-cell">0</td>
                                            <td class="pts pts-cell">0</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="flex gap-4 mt-4 pt-3 border-t border-gray-100 text-xs text-ink-muted">
                                <span><span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span> Top 2 qualify</span>
                                <span><span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span> Third place</span>
                            </div>
                        </div>
                    </div>

                    <!-- Matches Column -->
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-ink">Matches</h3>
                                <span class="text-xs text-ink-muted predictions-count">0/{{ group_data.matches|length }}</span>
                            </div>

                            <div class="matches-container">
                                {% for match in group_data.matches %}
                                    <div class="match-card"
                                         data-match-number="{{ match.match_number }}"
                                         data-home-team-id="{{ match.home_team_id }}"
                                         data-away-team-id="{{ match.away_team_id }}"
                                         data-group="{{ group_letter }}">

                                        <div class="match-row">
                                            <!-- Home Team -->
                                            <div class="team home">
                                                <span class="truncate">{{ match.home_team.name }}</span>
                                                {{ flag(match.home_team.country_code, 20) }}
                                            </div>

                                            <!-- Prediction Controls -->
                                            <div class="prediction-controls">
                                                <input type="number" min="0" max="20" class="score-input home-score" placeholder="-" onchange="handleScoreChange({{ match.match_number }})">

                                                <div class="flex gap-1">
                                                    <button type="button" class="pred-btn prediction-btn" data-outcome="home_win" onclick="handlePrediction({{ match.match_number }}, 'home_win')">H</button>
                                                    <button type="button" class="pred-btn prediction-btn" data-outcome="draw" onclick="handlePrediction({{ match.match_number }}, 'draw')">D</button>
                                                    <button type="button" class="pred-btn prediction-btn" data-outcome="away_win" onclick="handlePrediction({{ match.match_number }}, 'away_win')">A</button>
                                                </div>

                                                <input type="number" min="0" max="20" class="score-input away-score" placeholder="-" onchange="handleScoreChange({{ match.match_number }})">
                                            </div>

                                            <!-- Away Team -->
                                            <div class="team away">
                                                {{ flag(match.away_team.country_code, 20) }}
                                                <span class="truncate">{{ match.away_team.name }}</span>
                                            </div>
                                        </div>
                                        <div class="match-meta-top">
                                            <div>{{ match.scheduled_datetime.strftime('%b %d, %Y · %H:%M') }}</div>
                                            {% if match.stadium %}
                                                <div>{{ match.stadium.name }} · {{ match.stadium.city }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        {% endfor %}

        <!-- Third Place Ranking Section -->
        <div class="mt-12 pt-8 border-t border-gray-200">
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-ink mb-2" style="font-family: 'Cormorant Garamond', serif;">Third Place Ranking</h2>
                <p class="text-ink-muted text-sm">Drag to reorder. Top 8 teams advance to Round of 32.</p>
            </div>

            <div class="max-w-2xl">
                <div id="ranking-list" class="space-y-2">
                    <p class="text-ink-muted text-center py-8">Complete group predictions to see third-place teams</p>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t border-gray-100">
                <button onclick="goToKnockout()" class="btn-primary text-base px-8 py-3 cursor-pointer">
                    Continue to Knockout Stage &rarr;
                </button>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Initialize match data from server
window.matchData = {{ match_data_json|safe }};

// Group teams data for standings calculation
window.groupTeams = {
    {% for group_letter, group_data in groups.items() %}
    '{{ group_letter }}': [
        {% for team in group_data.teams %}
        { id: {{ team.id }}, name: '{{ team.name }}', country_code: '{{ team.country_code }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

let currentActiveGroup = null;

function updateActiveNav(groupLetter) {
    document.querySelectorAll('.group-pill').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.groupNav === groupLetter);
    });
}

function setActiveGroup(groupLetter) {
    currentActiveGroup = groupLetter;
    updateActiveNav(groupLetter);
}

function initGroupObserver() {
    const sections = document.querySelectorAll('[data-group-section]');
    if (!sections.length) return;

    const observer = new IntersectionObserver(entries => {
        const visible = entries.filter(entry => entry.isIntersecting);
        if (!visible.length) return;

        visible.sort((a, b) => b.intersectionRatio - a.intersectionRatio);
        const groupLetter = visible[0].target.dataset.groupSection;
        if (groupLetter && groupLetter !== currentActiveGroup) {
            setActiveGroup(groupLetter);
        }
    }, { threshold: [0.2, 0.4, 0.6], rootMargin: '-20% 0px -60% 0px' });

    sections.forEach(section => observer.observe(section));

    const firstGroup = sections[0].dataset.groupSection;
    if (firstGroup) {
        setActiveGroup(firstGroup);
    }
}

// Handle prediction button click
function handlePrediction(matchNumber, outcome) {
    const matchRow = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchRow) return;

    const homeScoreInput = matchRow.querySelector('.home-score');
    const awayScoreInput = matchRow.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    selectPrediction(matchNumber, outcome);
    savePredictionLocal(matchNumber, outcome, homeScore, awayScore, null, true);
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
}

// Handle score input change
function handleScoreChange(matchNumber) {
    const matchRow = document.querySelector(`[data-match-number="${matchNumber}"]`);
    if (!matchRow) return;

    const homeScoreInput = matchRow.querySelector('.home-score');
    const awayScoreInput = matchRow.querySelector('.away-score');
    const homeScore = homeScoreInput?.value ? parseInt(homeScoreInput.value) : null;
    const awayScore = awayScoreInput?.value ? parseInt(awayScoreInput.value) : null;

    let outcome = null;
    if (homeScore !== null && awayScore !== null) {
        if (homeScore > awayScore) outcome = 'home_win';
        else if (awayScore > homeScore) outcome = 'away_win';
        else outcome = 'draw';
        selectPrediction(matchNumber, outcome);
    }

    const currentPred = window.bracketState.groupPredictions[matchNumber];
    const finalOutcome = outcome || (currentPred ? currentPred.outcome : null);

    if (finalOutcome) {
        savePredictionLocal(matchNumber, finalOutcome, homeScore, awayScore, null, true);
        recalculateAllStandings();
        updateAllProgressIndicators();
        applyActualResultsToGroups();
    }
}

// Update progress indicators
function updateAllProgressIndicators() {
    const groupLetters = Object.keys(window.groupTeams);
    let totalPredicted = 0;

    groupLetters.forEach(group => {
        const section = document.querySelector(`[data-group-section="${group}"]`);
        const navPill = document.querySelector(`[data-group-nav="${group}"]`);
        if (!section) return;

        const matchRows = section.querySelectorAll('[data-match-number]');
        let predictedCount = 0;

        matchRows.forEach(row => {
            const matchNumber = row.dataset.matchNumber;
            if (window.bracketState.groupPredictions[matchNumber]) {
                predictedCount++;
                totalPredicted++;
            }
        });

        // Update count display
        const countEl = section.querySelector('.predictions-count');
        if (countEl) {
            countEl.textContent = `${predictedCount}/${matchRows.length}`;
        }

        // Update progress dot
        const progressDot = navPill?.querySelector('.progress-dot');
        if (progressDot) {
            progressDot.classList.remove('partial', 'complete');
            if (predictedCount === matchRows.length) {
                progressDot.classList.add('complete');
            } else if (predictedCount > 0) {
                progressDot.classList.add('partial');
            }
        }
    });

    // Update total progress
    const totalEl = document.getElementById('totalProgress');
    if (totalEl) {
        totalEl.textContent = `${totalPredicted}/72`;
    }
}

function calculateGroupMatchResult(prediction, matchInfo) {
    if (!matchInfo || matchInfo.status !== 'completed') return null;
    if (matchInfo.actualHomeScore === null || matchInfo.actualAwayScore === null) return null;

    const actualHomeScore = matchInfo.actualHomeScore;
    const actualAwayScore = matchInfo.actualAwayScore;

    let actualOutcome;
    if (actualHomeScore > actualAwayScore) actualOutcome = 'home_win';
    else if (actualAwayScore > actualHomeScore) actualOutcome = 'away_win';
    else actualOutcome = 'draw';

    let points = 0;
    let className = 'incorrect';
    let pointsText = 'No prediction';

    if (prediction) {
        const predHomeScore = prediction.homeScore ?? null;
        const predAwayScore = prediction.awayScore ?? null;

        if (predHomeScore !== null && predAwayScore !== null &&
            predHomeScore === actualHomeScore && predAwayScore === actualAwayScore) {
            points = 3;
            className = 'correct-exact';
        } else if (prediction.outcome === actualOutcome) {
            points = 1;
            className = 'correct-outcome';
        }

        pointsText = `+${points} pts`;
    }

    const pointsClass = points >= 3 ? 'points-3' : (points === 1 ? 'points-1' : 'points-0');
    return { className, pointsText, pointsClass, actualHomeScore, actualAwayScore };
}

function applyActualResultsToGroups() {
    document.querySelectorAll('.match-card .actual-result-bar').forEach(el => el.remove());

    document.querySelectorAll('.match-card[data-match-number]').forEach(card => {
        card.classList.remove('correct-exact', 'correct-outcome', 'incorrect');

        const matchNumber = card.dataset.matchNumber;
        const matchInfo = window.matchData?.[matchNumber];
        const prediction = window.bracketState.groupPredictions?.[matchNumber];
        const result = calculateGroupMatchResult(prediction, matchInfo);
        if (!result) return;

        card.classList.add(result.className);

        const bar = document.createElement('div');
        bar.className = 'actual-result-bar';
        bar.innerHTML = `
            <span class="actual-score">Actual: ${result.actualHomeScore} - ${result.actualAwayScore}</span>
            <span class="points-badge-small ${result.pointsClass}">${result.pointsText}</span>
        `;

        card.appendChild(bar);
    });
}

function generateRandomScoreForOutcome(outcome) {
    let homeScore;
    let awayScore;

    if (outcome === 'home_win') {
        homeScore = Math.floor(Math.random() * 4) + 1;
        awayScore = Math.floor(Math.random() * homeScore);
    } else if (outcome === 'away_win') {
        awayScore = Math.floor(Math.random() * 4) + 1;
        homeScore = Math.floor(Math.random() * awayScore);
    } else {
        homeScore = awayScore = Math.floor(Math.random() * 4);
    }

    return { homeScore, awayScore };
}

function randomizeActiveGroup() {
    const group = currentActiveGroup || Object.keys(window.groupTeams)[0];
    if (!group) return;
    autoSelectGroup(group);
}

// Auto-select all groups
async function autoSelectAllGroups() {
    const matchRows = document.querySelectorAll('[data-match-number]');
    let selectedCount = 0;

    matchRows.forEach(row => {
        const matchNumber = parseInt(row.dataset.matchNumber);
        if (matchNumber <= 72) {
            const outcomes = ['home_win', 'draw', 'away_win'];
            const randomOutcome = outcomes[Math.floor(Math.random() * 3)];
            const { homeScore, awayScore } = generateRandomScoreForOutcome(randomOutcome);

            selectPrediction(matchNumber, randomOutcome);
            row.querySelector('.home-score').value = homeScore;
            row.querySelector('.away-score').value = awayScore;
            savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
            selectedCount++;
        }
    });

    updateURLState();
    await new Promise(resolve => setTimeout(resolve, 50));
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
    showToast(`Auto-filled ${selectedCount} matches`, 'success');
}

// Auto-select single group
async function autoSelectGroup(groupLetter) {
    const section = document.querySelector(`[data-group-section="${groupLetter}"]`);
    if (!section) return;

    const matchRows = section.querySelectorAll('[data-match-number]');
    let selectedCount = 0;

    matchRows.forEach(row => {
        const matchNumber = parseInt(row.dataset.matchNumber);
        const outcomes = ['home_win', 'draw', 'away_win'];
        const randomOutcome = outcomes[Math.floor(Math.random() * 3)];
        const { homeScore, awayScore } = generateRandomScoreForOutcome(randomOutcome);

        selectPrediction(matchNumber, randomOutcome);
        row.querySelector('.home-score').value = homeScore;
        row.querySelector('.away-score').value = awayScore;
        savePredictionLocal(matchNumber, randomOutcome, homeScore, awayScore, null, true);
        selectedCount++;
    });

    updateURLState();
    await new Promise(resolve => setTimeout(resolve, 50));
    recalculateAllStandings();
    updateAllProgressIndicators();
    applyActualResultsToGroups();
    showToast(`Group ${groupLetter}: ${selectedCount} matches filled`, 'success');
}

// Recalculate all group standings
function recalculateAllStandings() {
    const groupLetters = Object.keys(window.groupTeams);
    const thirdPlaceTeams = [];

    groupLetters.forEach(group => {
        const standings = calculateGroupStandings(group, window.groupTeams[group], window.bracketState.groupPredictions);
        updateStandingsUI(group, standings);

        if (standings.length >= 3) {
            thirdPlaceTeams.push({
                ...standings[2],
                group: group
            });
        }
    });

    updateThirdPlaceRanking(thirdPlaceTeams);
}

// Update standings table UI
function updateStandingsUI(groupLetter, standings) {
    const table = document.getElementById(`standings-${groupLetter}`);
    if (!table) return;

    const tbody = table.querySelector('tbody');

    standings.forEach((team, index) => {
        const row = tbody.querySelector(`tr[data-team-id="${team.team_id}"]`);
        if (row) {
            row.querySelector('.rank-cell').textContent = index + 1;
            row.querySelector('.played-cell').textContent = team.played;
            row.querySelector('.gf-cell').textContent = team.goals_for;
            row.querySelector('.ga-cell').textContent = team.goals_against;
            row.querySelector('.gd-cell').textContent = team.goal_diff;
            row.querySelector('.pts-cell').textContent = team.points;

            row.className = '';
            row.setAttribute('data-team-id', team.team_id);
            if (index < 2) {
                row.classList.add('qualifies');
            } else if (index === 2) {
                row.classList.add('third-place');
            }

            tbody.appendChild(row);
        }
    });
}

// Update third place ranking UI
function updateThirdPlaceRanking(thirdPlaceTeams) {
    const rankingList = document.getElementById('ranking-list');
    if (!rankingList) return;

    thirdPlaceTeams.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.goal_diff !== a.goal_diff) return b.goal_diff - a.goal_diff;
        return b.goals_for - a.goals_for;
    });

    if (window.bracketState.thirdPlaceRanking && window.bracketState.thirdPlaceRanking.length > 0) {
        const rankedTeams = [];
        const unrankedTeams = [...thirdPlaceTeams];

        window.bracketState.thirdPlaceRanking.forEach(teamId => {
            const idx = unrankedTeams.findIndex(t => t.team_id === teamId);
            if (idx !== -1) {
                rankedTeams.push(unrankedTeams.splice(idx, 1)[0]);
            }
        });

        thirdPlaceTeams.length = 0;
        thirdPlaceTeams.push(...rankedTeams, ...unrankedTeams);
    }

    if (thirdPlaceTeams.length === 0 || thirdPlaceTeams.every(t => t.played === 0)) {
        rankingList.innerHTML = '<p class="text-ink-muted text-center py-8">Complete group predictions to see third-place teams</p>';
        return;
    }

    rankingList.innerHTML = thirdPlaceTeams.map((team, index) => `
        <div class="third-place-item ${index < 8 ? 'qualifies' : ''}" data-team-id="${team.team_id}" draggable="true">
            <div class="flex items-center gap-3">
                <span class="w-6 h-6 flex items-center justify-center text-xs font-bold rounded ${index < 8 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'}">${index + 1}</span>
                <div>
                    <div class="font-medium text-sm">${team.team_name}</div>
                    <div class="text-xs text-ink-muted">Group ${team.group}</div>
                </div>
            </div>
            <div class="flex gap-4 text-xs">
                <div class="text-center">
                    <div class="font-bold">${team.points}</div>
                    <div class="text-ink-muted">Pts</div>
                </div>
                <div class="text-center">
                    <div class="font-bold">${team.goal_diff >= 0 ? '+' : ''}${team.goal_diff}</div>
                    <div class="text-ink-muted">GD</div>
                </div>
                <div class="text-center">
                    <div class="font-bold">${team.goals_for}</div>
                    <div class="text-ink-muted">GF</div>
                </div>
            </div>
        </div>
    `).join('');

    initDragAndDrop();
}

// Initialize drag and drop
function initDragAndDrop() {
    const list = document.getElementById('ranking-list');
    if (!list) return;

    let draggedItem = null;

    list.querySelectorAll('.third-place-item').forEach(item => {
        item.addEventListener('dragstart', function() {
            draggedItem = this;
            this.classList.add('dragging');
        });

        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            draggedItem = null;
            saveThirdPlaceOrder();
        });

        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        item.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedItem !== this) {
                const allItems = [...list.querySelectorAll('.third-place-item')];
                const draggedIdx = allItems.indexOf(draggedItem);
                const targetIdx = allItems.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }

                updateRankBadges();
            }
        });
    });
}

// Update rank badges after reordering
function updateRankBadges() {
    const items = document.querySelectorAll('#ranking-list .third-place-item');
    items.forEach((item, index) => {
        const rankBadge = item.querySelector('span:first-child');
        rankBadge.textContent = index + 1;

        if (index < 8) {
            item.classList.add('qualifies');
            rankBadge.classList.add('bg-green-500', 'text-white');
            rankBadge.classList.remove('bg-gray-200', 'text-gray-600');
        } else {
            item.classList.remove('qualifies');
            rankBadge.classList.remove('bg-green-500', 'text-white');
            rankBadge.classList.add('bg-gray-200', 'text-gray-600');
        }
    });
}

// Save third place order
function saveThirdPlaceOrder() {
    const items = document.querySelectorAll('#ranking-list .third-place-item');
    const rankings = [];
    items.forEach(item => {
        const teamId = parseInt(item.dataset.teamId);
        if (!isNaN(teamId)) {
            rankings.push(teamId);
        }
    });
    saveThirdPlaceRanking(rankings);
    updateRankBadges();
}

// Navigate to knockout page
function goToKnockout() {
    const encoded = encodeState(window.bracketState);
    if (encoded) {
        window.location.href = `/bracket?s=${encoded}`;
    } else {
        window.location.href = '/bracket';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        recalculateAllStandings();
        updateAllProgressIndicators();
        applyActualResultsToGroups();
        initGroupObserver();
    }, 100);
});
</script>
{% endblock %}
