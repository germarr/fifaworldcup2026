{% extends "base.html" %}

{% block title %}Manage Matches - Admin{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Matches</h1>
        <a href="/admin" class="btn-secondary">Back to Dashboard</a>
    </div>

    <!-- Filter -->
    <div class="card mb-6">
        <form method="GET" class="flex gap-4 items-end">
            <div>
                <label class="block text-sm font-medium mb-1">Filter by Round</label>
                <select name="round_filter" class="input-field" onchange="this.form.submit()">
                    <option value="">All Rounds</option>
                    <option value="group_stage" {{ 'selected' if round_filter == 'group_stage' }}>Group Stage</option>
                    <option value="round_of_32" {{ 'selected' if round_filter == 'round_of_32' }}>Round of 32</option>
                    <option value="round_of_16" {{ 'selected' if round_filter == 'round_of_16' }}>Round of 16</option>
                    <option value="quarter_final" {{ 'selected' if round_filter == 'quarter_final' }}>Quarter Finals</option>
                    <option value="semi_final" {{ 'selected' if round_filter == 'semi_final' }}>Semi Finals</option>
                    <option value="third_place" {{ 'selected' if round_filter == 'third_place' }}>Third Place</option>
                    <option value="final" {{ 'selected' if round_filter == 'final' }}>Final</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Matches List -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">Matches ({{ matches|length }})</h2>

        {% if matches %}
            <div class="space-y-4">
                {% for item in matches %}
                    {% set match = item.match %}
                    {% set home_team = item.home_team %}
                    {% set away_team = item.away_team %}
                    {% set stadium = item.stadium %}

                    <div class="border rounded-lg p-4 {% if match.status == 'completed' %}bg-green-50{% endif %}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-sm text-gray-500">Match #{{ match.match_number }}</span>
                                <span class="text-sm text-gray-500 ml-2">{{ match.round.replace('_', ' ').title() }}</span>
                                {% if match.group_letter %}
                                    <span class="text-sm text-fifa-blue ml-2">Group {{ match.group_letter }}</span>
                                {% endif %}
                            </div>
                            <div class="text-sm text-gray-500">
                                {{ match.scheduled_datetime.strftime('%Y-%m-%d %H:%M') if match.scheduled_datetime else 'TBD' }}
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2 w-40">
                                        <span class="text-xl">{{ home_team.flag_emoji if home_team else 'üè≥Ô∏è' }}</span>
                                        <span class="font-medium">{{ home_team.name if home_team else 'TBD' }}</span>
                                    </div>
                                    <div class="text-center w-24">
                                        {% if match.status == 'completed' %}
                                            <span class="text-2xl font-bold">
                                                {{ match.actual_home_score }} - {{ match.actual_away_score }}
                                            </span>
                                        {% else %}
                                            <span class="text-gray-400">vs</span>
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 w-40">
                                        <span class="text-xl">{{ away_team.flag_emoji if away_team else 'üè≥Ô∏è' }}</span>
                                        <span class="font-medium">{{ away_team.name if away_team else 'TBD' }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Score Input -->
                            {% if home_team and away_team %}
                                <form method="POST" action="/admin/matches/{{ match.id }}/score" class="flex items-center gap-2 ml-4">
                                    <input
                                        type="number"
                                        name="home_score"
                                        min="0"
                                        value="{{ match.actual_home_score if match.actual_home_score is not none else '' }}"
                                        class="w-16 input-field text-center"
                                        placeholder="0"
                                    >
                                    <span>-</span>
                                    <input
                                        type="number"
                                        name="away_score"
                                        min="0"
                                        value="{{ match.actual_away_score if match.actual_away_score is not none else '' }}"
                                        class="w-16 input-field text-center"
                                        placeholder="0"
                                    >
                                    <button type="submit" class="btn-primary text-sm">
                                        {{ 'Update' if match.status == 'completed' else 'Save' }}
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                        {% if stadium %}
                            <div class="text-sm text-gray-500 mt-2">
                                {{ stadium.name }}, {{ stadium.city }}
                            </div>
                        {% endif %}

                        <!-- Penalty winner for knockout draws -->
                        {% if match.round != 'group_stage' and match.status == 'completed' and match.actual_home_score == match.actual_away_score %}
                            <div class="mt-2 pt-2 border-t">
                                <form method="POST" action="/admin/matches/{{ match.id }}/winner" class="flex items-center gap-2">
                                    <span class="text-sm text-gray-600">Penalty Winner:</span>
                                    <select name="winner_team_id" class="input-field w-auto">
                                        <option value="{{ home_team.id }}" {{ 'selected' if match.actual_winner_team_id == home_team.id }}>
                                            {{ home_team.name }}
                                        </option>
                                        <option value="{{ away_team.id }}" {{ 'selected' if match.actual_winner_team_id == away_team.id }}>
                                            {{ away_team.name }}
                                        </option>
                                    </select>
                                    <button type="submit" class="btn-secondary text-sm">Set Winner</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500">No matches found. Run the seed script to add matches.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
